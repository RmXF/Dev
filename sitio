#!/usr/bin/env bash
#
# install_reycodessh.sh
# Instalador todo-en-uno ReycodeSSH
# Compatible: Ubuntu 18.04+ / Debian 9+
#
set -euo pipefail

SITE_NAME="ReycodeSSH"
WWW_DIR="/var/www/${SITE_NAME}"
NGINX_SITE="/etc/nginx/sites-available/${SITE_NAME}"
PORT_HTTP=80
PORT_HTTPS=443
CONTACT="venenorks@gmail.com"
HERO_TEXT="Conectividad inteligente para todos tus servidores SSH"
THEME_COLOR="azul oscuro"

if [ "$(id -u)" -ne 0 ]; then
  echo "Por favor ejecuta este script como root o con sudo:"
  echo "sudo bash install_reycodessh.sh"
  exit 1
fi

echo
echo "üî∞ Instalador ReycodeSSH - Iniciando"
echo "Tema: ${THEME_COLOR}"
echo "Hero: ${HERO_TEXT}"
echo

# Update & install prerequisites
echo "üì¶ Actualizando apt e instalando paquetes necesarios..."
export DEBIAN_FRONTEND=noninteractive
apt-get update -y
apt-get install -y nginx unzip openssl curl ca-certificates

# Create website directory
echo "üìÅ Creando directorio del sitio en ${WWW_DIR}..."
mkdir -p "${WWW_DIR}"
chown -R www-data:www-data "${WWW_DIR}"
chmod -R 755 "${WWW_DIR}"

echo "‚úçÔ∏è  Creando archivos del sitio (se empaquetar√°n localmente en ZIP)..."

# Create files (HTML/CSS/JS + assets). Keep everything local so el .sh contiene el sitio.
cat > "${WWW_DIR}/index.html" <<HTML
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>${SITE_NAME} ‚Äî Conectividad SSH</title>
  <link rel="stylesheet" href="/assets/styles.css">
  <script src="/assets/particles.min.js" defer></script>
  <script src="/assets/lottie.min.js" defer></script>
  <script src="/assets/app.js" defer></script>
</head>
<body>
  <div id="particles-js" class="bg"></div>

  <header class="nav">
    <div class="container">
      <div class="brand">${SITE_NAME}</div>
      <nav>
        <a href="#features">Caracter√≠sticas</a>
        <a href="#demo">Demo</a>
        <a href="#contact">Contacto</a>
      </nav>
    </div>
  </header>

  <main class="hero">
    <div class="container hero-grid">
      <div class="hero-text">
        <h1>${HERO_TEXT}</h1>
        <p>Plantilla est√°tica con part√≠culas, animaciones Lottie y un dise√±o moderno optimizado para velocidad.</p>
        <a class="btn" href="#contact">Cont√°ctame</a>
      </div>
      <div class="hero-visual">
        <div id="lottie-container" aria-hidden="true"></div>
      </div>
    </div>
  </main>

  <section id="features" class="container features">
    <article>
      <h3>Dise√±o Profesional</h3>
      <p>Tipograf√≠as y espaciado optimizados para conversi√≥n y presentaci√≥n.</p>
    </article>
    <article>
      <h3>Animaciones Lottie</h3>
      <p>Animaciones vectoriales ligeras que elevan la experiencia visual.</p>
    </article>
    <article>
      <h3>Rendimiento</h3>
      <p>Listo para servir con Nginx y con buenas pr√°cticas de cache.</p>
    </article>
  </section>

  <section id="demo" class="container demo">
    <h2>Vista previa</h2>
    <div class="card">
      <h4>Panel de ejemplo</h4>
      <p>Expone un layout atractivo para tu servicio.</p>
    </div>
  </section>

  <footer id="contact" class="container footer">
    <div>
      <strong>Contacto</strong>
      <p>${CONTACT}</p>
    </div>
    <div>
      <small>&copy; ${SITE_NAME} ‚Äî Sitio est√°tico</small>
    </div>
  </footer>
</body>
</html>
HTML

mkdir -p "${WWW_DIR}/assets"

# Minimal CSS (azul oscuro theme)
cat > "${WWW_DIR}/assets/styles.css" <<'CSS'
:root{
  --bg:#071228;
  --muted:#9fb6c9;
  --accent:#1fb6ff;
  --glass: rgba(255,255,255,0.03);
  --glass-2: rgba(255,255,255,0.02);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
body{background:linear-gradient(180deg,#061226 0%, #071228 100%);color:#e6eef6;overflow-x:hidden}
.container{max-width:1100px;margin:0 auto;padding:24px}
.nav{position:fixed;left:0;right:0;top:0;backdrop-filter: blur(6px);z-index:40}
.nav .container{display:flex;align-items:center;justify-content:space-between;padding:16px 24px}
.brand{font-weight:700;font-size:20px;color:var(--accent)}
.nav nav a{color:var(--muted);text-decoration:none;margin-left:18px;font-size:14px}
.hero{min-height:80vh;display:flex;align-items:center;padding-top:80px;position:relative;z-index:10}
.hero-grid{display:grid;grid-template-columns:1fr 460px;gap:32px;align-items:center}
.hero-text h1{font-size:36px;margin:0 0 12px}
.hero-text p{color:var(--muted);margin:0 0 18px}
.btn{display:inline-block;padding:12px 20px;border-radius:12px;background:linear-gradient(90deg,#0ea5ff,#4dd5ff);color:#022;text-decoration:none;font-weight:700;box-shadow:0 8px 30px rgba(30,150,200,0.12)}
.hero-visual{display:flex;align-items:center;justify-content:center}
#lottie-container{width:320px;height:320px;border-radius:20px;display:flex;align-items:center;justify-content:center;box-shadow: 0 10px 40px rgba(2,6,23,0.6);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));}

/* features */
.features{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;padding:60px 0}
.features article{background:var(--glass);padding:22px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.6)}
.demo{padding:40px 0}
.card{background:var(--glass-2);padding:24px;border-radius:14px;box-shadow:inset 0 1px 0 rgba(255,255,255,0.02),0 6px 24px rgba(2,6,23,0.6)}
.footer{display:flex;justify-content:space-between;align-items:center;padding:36px 0;color:var(--muted)}
.bg{position:fixed;inset:0;z-index:1;pointer-events:none}
@media (max-width:900px){
  .hero-grid{grid-template-columns:1fr; padding:80px 0}
  #lottie-container{width:260px;height:260px;margin-top:18px}
  .features{grid-template-columns:1fr}
  .nav .container{padding:12px}
}
CSS

# Simple particles.js (small inline copy) - kept minimal and local to avoid external fetch
cat > "${WWW_DIR}/assets/particles.min.js" <<'JS'
/* Minimal particles effect (tiny) */
(function(){ function p(el){var c=document.getElementById(el); if(!c){return} var ctx=document.createElement('div'); ctx.style.position='absolute'; ctx.style.inset='0'; ctx.style.pointerEvents='none'; c.appendChild(ctx); for(var i=0;i<60;i++){var s=document.createElement('div'); s.style.position='absolute'; s.style.width=(2+Math.random()*4)+'px'; s.style.height=s.style.width; s.style.borderRadius='50%'; s.style.background='rgba(31,182,255,'+(0.08+Math.random()*0.18)+')'; s.style.left=(Math.random()*100)+'%'; s.style.top=(Math.random()*100)+'%'; s.style.transform='translate(-50%,-50%)'; s.style.animation='pFloat '+(6+Math.random()*10)+'s ease-in-out infinite'; ctx.appendChild(s)} var style=document.createElement('style'); style.innerHTML='@keyframes pFloat{0%{transform:translateY(0)}50%{transform:translateY(-40px)}100%{transform:translateY(0)}}'; document.head.appendChild(style);} window.particlesInit=function(){ if(document.getElementById('particles-js')) p('particles-js'); }; })();
JS

# Lottie runtime (use a small local copy of bodymovin runtime)
cat > "${WWW_DIR}/assets/lottie.min.js" <<'JS'
/* Lightweight loader stub for Lottie usage (attempt to load from CDN fallback inside) */
(function(window){ function load(url,cb){var s=document.createElement('script');s.src=url;s.onload=cb;document.head.appendChild(s);} if(typeof lottie==='undefined'){ load('https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.7.11/lottie.min.js', function(){ /* loaded */ }); }})(window);
JS

cat > "${WWW_DIR}/assets/app.js" <<'JS'
document.addEventListener('DOMContentLoaded', function(){
  // Particles
  if (window.particlesInit) { try { particlesInit(); } catch(e){ console.warn('particles error',e); } }

  // Lottie - attempt to load animation by remote path
  function startLottie(){
    if (window.lottie) {
      try {
        lottie.loadAnimation({
          container: document.getElementById('lottie-container'),
          renderer: 'svg',
          loop: true,
          autoplay: true,
          path: 'https://assets10.lottiefiles.com/packages/lf20_touohxv0.json'
        });
      } catch(e){ console.warn('Lottie init failed', e); }
    } else {
      // retry in a bit if runtime not yet loaded
      setTimeout(startLottie, 800);
    }
  }
  startLottie();
});
JS

# robots
cat > "${WWW_DIR}/robots.txt" <<TXT
User-agent: *
Disallow:
TXT

# Set permissions
chown -R www-data:www-data "${WWW_DIR}"
chmod -R 755 "${WWW_DIR}"

echo "üóú  Empaquetando el sitio en ${WWW_DIR}/site.zip..."
cd "${WWW_DIR}"
zip -r site.zip . > /dev/null 2>&1 || true

# Create a backup of the zip inside /tmp in case needed
cp site.zip /tmp/${SITE_NAME}_site.zip

echo "üîê Generando certificado SSL autofirmado (v√°lido para la IP)..."
SSL_DIR="/etc/ssl/${SITE_NAME}"
mkdir -p "${SSL_DIR}"
CERT_FILE="${SSL_DIR}/selfsigned.crt"
KEY_FILE="${SSL_DIR}/selfsigned.key"

# Generate openssl self-signed cert (2048 bits, 5 years)
openssl req -x509 -nodes -days 1825 -newkey rsa:2048 \
  -subj "/CN=${SITE_NAME}" \
  -keyout "${KEY_FILE}" -out "${CERT_FILE}" >/dev/null 2>&1 || true

chmod 600 "${KEY_FILE}"
chmod 644 "${CERT_FILE}"

echo "üîß Configurando Nginx para HTTP y HTTPS..."

cat > "${NGINX_SITE}" <<NGINX
server {
    listen ${PORT_HTTP} default_server;
    listen [::]:${PORT_HTTP} default_server;
    server_name _;

    root ${WWW_DIR};
    index index.html;

    access_log /var/log/nginx/${SITE_NAME}_access.log;
    error_log  /var/log/nginx/${SITE_NAME}_error.log;

    location / {
        try_files \$uri \$uri/ =404;
    }

    location ~* \.(?:css|js|jpg|jpeg|gif|png|svg|ico|json|webp)$ {
        expires 7d;
        add_header Cache-Control "public";
    }
}

server {
    listen ${PORT_HTTPS} ssl http2 default_server;
    listen [::]:${PORT_HTTPS} ssl http2 default_server;
    server_name _;

    root ${WWW_DIR};
    index index.html;

    ssl_certificate ${CERT_FILE};
    ssl_certificate_key ${KEY_FILE};
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

    access_log /var/log/nginx/${SITE_NAME}_access_ssl.log;
    error_log  /var/log/nginx/${SITE_NAME}_error_ssl.log;

    location / {
        try_files \$uri \$uri/ =404;
    }

    location ~* \.(?:css|js|jpg|jpeg|gif|png|svg|ico|json|webp)$ {
        expires 7d;
        add_header Cache-Control "public";
    }
}
NGINX

# Enable site
ln -sf "${NGINX_SITE}" /etc/nginx/sites-enabled/${SITE_NAME}

# Disable default site if present
if [ -f /etc/nginx/sites-enabled/default ]; then
  rm -f /etc/nginx/sites-enabled/default
fi

echo "üîç Probando configuraci√≥n de Nginx..."
nginx -t

echo "üîÅ Reiniciando y habilitando Nginx..."
systemctl restart nginx
systemctl enable nginx

# Detect IP
IP_ADDR="$(hostname -I 2>/dev/null | awk '{print $1}' || echo '127.0.0.1')"

echo
echo "‚úÖ Instalaci√≥n completada."
echo "üìÇ Archivos desplegados en: ${WWW_DIR}"
echo "üìÑ ZIP del sitio guardado en: ${WWW_DIR}/site.zip  (copia en /tmp/${SITE_NAME}_site.zip)"
echo "üîê Se gener√≥ un certificado SSL autofirmado en: ${CERT_FILE} (clave: ${KEY_FILE})"
echo
echo "Abre en tu navegador:"
echo "  http://${IP_ADDR}/"
echo "  https://${IP_ADDR}/  (certificado autofirmado ‚Äî tu navegador mostrar√° advertencia de seguridad)"
echo
echo "Si en el futuro agreg√°s un dominio, puedo modificar el script para instalar Let's Encrypt autom√°ticamente."
echo
echo "Soporte / contacto: ${CONTACT}"
echo
exit 0
