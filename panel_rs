#!/bin/bash
# Panel Web ReyCodeSSH - Instalador y Gestor
# By GPT-5 | Versi√≥n Mejorada con Men√∫ y Actualizaci√≥n

PANEL_DIR="/var/www/reycodessh"
CONF_FILE="/etc/apache2/sites-available/reycodessh.conf"
PORT=80
USER="admin"
PASS="admin123"
ZIP_URL="https://raw.githubusercontent.com/RmXF/Dev/main/panel_v1.zip" # Cambiar por tu URL real

# Funci√≥n: Instalar dependencias
instalar_dependencias() {
    echo -e "\033[1;33m[+] Instalando dependencias...\033[0m"
    apt update -y >/dev/null 2>&1
    apt install apache2 php libapache2-mod-php unzip wget -y >/dev/null 2>&1
}

# Funci√≥n: Configurar Apache
configurar_apache() {
    echo -e "\033[1;33m[+] Configurando Apache...\033[0m"
    cat <<EOF > "$CONF_FILE"
<VirtualHost *:${PORT}>
    ServerAdmin admin@localhost
    DocumentRoot ${PANEL_DIR}
    <Directory ${PANEL_DIR}>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>
    ErrorLog \${APACHE_LOG_DIR}/panel_error.log
    CustomLog \${APACHE_LOG_DIR}/panel_access.log combined
</VirtualHost>
EOF

    a2dissite 000-default.conf >/dev/null 2>&1
    a2ensite reycodessh.conf >/dev/null 2>&1
    a2enmod rewrite >/dev/null 2>&1
    systemctl reload apache2 >/dev/null 2>&1 || systemctl restart apache2 >/dev/null 2>&1
}

# Funci√≥n: Descargar y descomprimir panel desde ZIP
actualizar_panel() {
    echo -e "\033[1;33m[+] Descargando versi√≥n m√°s reciente del panel...\033[0m"
    wget -q -O /tmp/panel.zip "$ZIP_URL"
    if [ -s /tmp/panel.zip ]; then
        rm -rf "$PANEL_DIR"/*
        unzip -qo /tmp/panel.zip -d "$PANEL_DIR"
        echo -e "\033[1;32m‚úî Panel actualizado correctamente desde ZIP.\033[0m"
    else
        echo -e "\033[1;31m‚úñ No se pudo descargar el ZIP.\033[0m"
    fi
    rm -f /tmp/panel.zip
}

# Funci√≥n: Instalar panel base
instalar_panel() {
    rm -rf "$PANEL_DIR"
    mkdir -p "$PANEL_DIR/assets"
    cd "$PANEL_DIR"

    # Configuraci√≥n base
    cat <<EOF > config.php
<?php
\$usuario_panel = "$USER";
\$contrasena_panel = "$PASS";
?>
EOF

    # Index.php
    cat <<'EOF' > index.php
<?php
session_start();
include("config.php");
if (isset($_SESSION['usuario'])) { header("Location: dashboard.php"); exit(); }
$error = "";
if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $user = $_POST["usuario"];
    $pass = $_POST["contrasena"];
    if ($user === $usuario_panel && $pass === $contrasena_panel) {
        $_SESSION['usuario'] = $user;
        header("Location: dashboard.php");
        exit();
    } else { $error = "Usuario o contrase√±a incorrectos"; }
}
?>
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Login - Panel Web</title>
<link rel="stylesheet" href="assets/style.css">
</head>
<body class="login-body">
<div class="login-box">
    <h2>Panel Web</h2>
    <form method="POST">
        <input type="text" name="usuario" placeholder="Usuario" required>
        <input type="password" name="contrasena" placeholder="Contrase√±a" required>
        <button type="submit">Ingresar</button>
        <?php if ($error): ?>
            <p class="error"><?= $error ?></p>
        <?php endif; ?>
    </form>
</div>
<script src="assets/script.js"></script>
</body>
</html>
EOF

    # Dashboard.php
    cat <<'EOF' > dashboard.php
<?php
session_start();
if (!isset($_SESSION['usuario'])) { header("Location: index.php"); exit(); }
?>
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Dashboard - Panel Web</title>
<link rel="stylesheet" href="assets/style.css">
</head>
<body>
<nav class="navbar">
    <h1>Dashboard</h1>
    <a href="logout.php">Cerrar sesi√≥n</a>
</nav>
<main class="content">
    <div class="card">
        <h2>Bienvenido üëã</h2>
        <p>Has iniciado sesi√≥n correctamente en el panel web.</p>
    </div>
    <div class="card">
        <h3>Informaci√≥n del servidor</h3>
        <ul>
            <li>PHP: <?= phpversion() ?></li>
            <li>Servidor: <?= $_SERVER['SERVER_SOFTWARE'] ?></li>
            <li>IP: <?= $_SERVER['SERVER_ADDR'] ?></li>
        </ul>
    </div>
</main>
<script src="assets/script.js"></script>
</body>
</html>
EOF

    # Logout.php
    cat <<'EOF' > logout.php
<?php
session_start();
session_destroy();
header("Location: index.php");
exit();
?>
EOF

    # Assets
    cat <<'EOF' > assets/style.css
body { font-family: "Segoe UI", sans-serif; background: #0f172a; color: #f8fafc; margin:0; padding:0; }
.login-body { display:flex; justify-content:center; align-items:center; height:100vh; }
.login-box { background:#1e293b; padding:2em; border-radius:15px; box-shadow:0 0 25px rgba(0,0,0,0.4); width:300px; text-align:center; }
.login-box h2 { margin-bottom:20px; }
.login-box input { width:100%; padding:10px; margin-bottom:10px; border:none; border-radius:8px; background:#334155; color:#fff; }
.login-box button { background:#2563eb; border:none; padding:10px; width:100%; border-radius:8px; cursor:pointer; color:#fff; font-weight:bold; transition:0.3s; }
.login-box button:hover { background:#1d4ed8; }
.error { color:#f87171; margin-top:10px; }
.navbar { display:flex; justify-content:space-between; align-items:center; background:#1e293b; padding:15px 25px; }
.navbar a { color:#f8fafc; text-decoration:none; background:#dc2626; padding:8px 12px; border-radius:8px; }
.content { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:1em; padding:2em; }
.card { background:#1e293b; border-radius:12px; padding:1.5em; box-shadow:0 0 10px rgba(0,0,0,0.3); }
EOF

    echo 'console.log("Panel Web cargado correctamente.");' > assets/script.js

    configurar_apache

    IP=$(hostname -I | awk '{print $1}')
    echo -e "\033[1;32m‚úî Instalaci√≥n completada.\033[0m"
    echo -e "üåê Acceso: http://$IP:$PORT"
    echo -e "üë§ Usuario: $USER"
    echo -e "üîë Contrase√±a: $PASS"
}

# Funci√≥n: Desinstalar panel
desinstalar_panel() {
    rm -rf "$PANEL_DIR"
    a2dissite reycodessh.conf >/dev/null 2>&1
    systemctl reload apache2 >/dev/null 2>&1
    echo -e "\033[1;31m‚úî Panel desinstalado correctamente.\033[0m"
}

# Funci√≥n: Men√∫ principal
menu() {
    clear
    echo -e "\033[1;36m‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\033[0m"
    echo -e "     üöÄ PANEL WEB - REYCODESSH     "
    echo -e "\033[1;36m‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\033[0m"
    echo ""
    echo "1) Instalar panel base"
    echo "2) Actualizar panel desde ZIP"
    echo "3) Desinstalar panel"
    echo "4) Salir"
    echo ""
    read -p "Seleccione una opci√≥n: " opcion
    case $opcion in
        1) instalar_dependencias; instalar_panel ;;
        2) actualizar_panel ;;
        3) desinstalar_panel ;;
        4) exit 0 ;;
        *) echo "Opci√≥n inv√°lida"; sleep 2; menu ;;
    esac
    echo ""
    read -p "Presione Enter para volver al men√∫..." 
    menu
}

# Crear comando global para acceder al men√∫
crear_comando_global() {
    CMD_PATH="/usr/local/bin/panelmenu"
    echo "#!/bin/bash" > $CMD_PATH
    echo "bash $0" >> $CMD_PATH
    chmod +x $CMD_PATH
}

# Ejecutar
crear_comando_global
menu
