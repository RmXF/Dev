#!/bin/bash
# ===================================================
# ðŸ¤– RSBot - Bot de gestiÃ³n Telegram para ManagerRS
# ===================================================

CONFIG="/etc/RSbot_config"
LOG="/var/log/RSbot.log"

[[ ! -e $CONFIG ]] && echo "Archivo de configuraciÃ³n no encontrado." && exit 1

TOKEN=$(grep "token=" $CONFIG | cut -d'=' -f2)
CHAT_ID=$(grep "chat_id=" $CONFIG | cut -d'=' -f2)
API="https://api.telegram.org/bot$TOKEN"
OFFSET=0

send_msg() {
  local MSG="$1"
  curl -s -X POST "$API/sendMessage" -d chat_id="$CHAT_ID" -d text="$MSG" -d parse_mode="HTML" >/dev/null
}

send_keyboard() {
  local TEXT="$1"
  local KEYBOARD="$2"
  curl -s -X POST "$API/sendMessage" \
    -d chat_id="$CHAT_ID" \
    -d text="$TEXT" \
    -d parse_mode="HTML" \
    -d reply_markup="$KEYBOARD" >/dev/null
}

build_main_keyboard() {
  cat <<EOF
{
  "inline_keyboard": [
    [
      {"text": "ðŸ“± Crear usuario", "callback_data": "crear"},
      {"text": "ðŸ—‘ Eliminar usuario", "callback_data": "eliminar"}
    ],
    [
      {"text": "â™»ï¸ Renovar usuario", "callback_data": "renovar"},
      {"text": "âš™ï¸ Alterar lÃ­mite", "callback_data": "limite"}
    ],
    [
      {"text": "â° Alterar expiraciÃ³n", "callback_data": "expiracion"}
    ]
  ]
}
EOF
}

process_callback() {
  local data="$1"
  local id="$2"

  case "$data" in
    "crear")
      send_msg "ðŸ‘¤ Ingrese el nombre del nuevo usuario:"
      ;;
    "eliminar")
      send_msg "ðŸ—‘ EnvÃ­e el nombre del usuario que desea eliminar:"
      ;;
    "renovar")
      send_msg "â™»ï¸ EnvÃ­e el nombre del usuario que desea renovar:"
      ;;
    "limite")
      send_msg "âš™ï¸ Ingrese el usuario y el nuevo lÃ­mite de conexiones:"
      ;;
    "expiracion")
      send_msg "â° Ingrese el usuario y los dÃ­as extra de expiraciÃ³n:"
      ;;
  esac
}

# ============================
#  INICIO DEL BOT
# ============================
send_keyboard "ðŸ¤– <b>Bienvenido al Panel de GestiÃ³n RS</b>\n\nSelecciona una acciÃ³n:" "$(build_main_keyboard)"

echo "$(date '+%F %T') RSBot iniciado." >> "$LOG"

while true; do
  UPDATES=$(curl -s "$API/getUpdates?offset=$OFFSET")

  # Leer nuevos mensajes
  for row in $(echo "$UPDATES" | jq -c '.result[]'); do
    UPDATE_ID=$(echo "$row" | jq '.update_id')
    OFFSET=$((UPDATE_ID + 1))

    CALLBACK_DATA=$(echo "$row" | jq -r '.callback_query.data // empty')
    CALLBACK_ID=$(echo "$row" | jq -r '.callback_query.id // empty')
    MESSAGE_TEXT=$(echo "$row" | jq -r '.message.text // empty')

    if [[ -n "$CALLBACK_DATA" ]]; then
      process_callback "$CALLBACK_DATA" "$CALLBACK_ID"
    elif [[ "$MESSAGE_TEXT" == "/start" ]]; then
      send_keyboard "ðŸ”¸ <b>Panel de control SSH</b>\nSelecciona una opciÃ³n:" "$(build_main_keyboard)"
    fi
  done

  sleep 2
done
