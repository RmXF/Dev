#!/bin/bash
# ─────────────────────────────────────────────
# Instalador automático de Panel Web en VPS
# Autor: nowpro + GPT-5
# Compatible con Ubuntu/Debian
# ─────────────────────────────────────────────

# Variables
PANEL_DIR="/var/www/reycodessh"
CONF_FILE="/etc/apache2/sites-available/reycodessh.conf"
PORT_FILE="/etc/apache2/ports.conf"
LOG_FILE="/var/log/instalador_panel.log"
DEFAULT_PORT=80

# ─────────────────────────────────────────────
# Colores
# ─────────────────────────────────────────────
GREEN="\033[1;32m"
RED="\033[1;31m"
YELLOW="\033[1;33m"
CYAN="\033[1;36m"
NC="\033[0m"

# ─────────────────────────────────────────────
echo -e "${CYAN}[*] Instalador automático del Panel Web ReyCodeSSH${NC}"
echo ""

read -p "Ingresa el puerto que deseas usar (default: ${DEFAULT_PORT}): " PANEL_PORT
PANEL_PORT=${PANEL_PORT:-$DEFAULT_PORT}

read -p "Ingresa usuario para el panel: " PANEL_USER
read -p "Ingresa contraseña para el panel: " PANEL_PASS

echo ""
echo -e "${YELLOW}[+] Instalando dependencias necesarias...${NC}"
apt update -y >> $LOG_FILE 2>&1
apt install apache2 php php-mysql libapache2-mod-php unzip wget -y >> $LOG_FILE 2>&1

# ─────────────────────────────────────────────
# Preparar directorios
# ─────────────────────────────────────────────
echo -e "${YELLOW}[+] Preparando directorios...${NC}"
rm -rf "$PANEL_DIR"
mkdir -p "$PANEL_DIR"
chown -R www-data:www-data "$PANEL_DIR"
chmod -R 755 "$PANEL_DIR"

# ─────────────────────────────────────────────
# Descargar el panel
# ─────────────────────────────────────────────
echo -e "${YELLOW}[+] Descargando el panel web...${NC}"
cd "$PANEL_DIR"
# 🔽 Reemplaza este link por tu ZIP real de Dropbox u otro hosting directo
wget -O panel.zip "https://www.dropbox.com/scl/fi/vnmoive81mirjbmwt1vev/panel_web.zip" >> $LOG_FILE 2>&1

if [ -f panel.zip ]; then
    unzip panel.zip -d "$PANEL_DIR" >> $LOG_FILE 2>&1
    rm -f panel.zip
else
    echo -e "${RED}[x] Error: No se pudo descargar el panel. Verifica el enlace.${NC}"
    exit 1
fi

# Crear config.php si no existe
if [ ! -f "$PANEL_DIR/config.php" ]; then
cat <<EOF > "$PANEL_DIR/config.php"
<?php
\$usuario_panel = '$PANEL_USER';
\$contrasena_panel = '$PANEL_PASS';
?>
EOF
fi

chown -R www-data:www-data "$PANEL_DIR"

# ─────────────────────────────────────────────
# Configurar Apache
# ─────────────────────────────────────────────
echo -e "${YELLOW}[+] Configurando Apache...${NC}"

# Obtener IP pública o local
IP_SERVER=$(hostname -I | awk '{print $1}')

# Crear configuración del sitio
cat <<EOF > "$CONF_FILE"
<VirtualHost *:${PANEL_PORT}>
    ServerAdmin admin@localhost
    ServerName ${IP_SERVER}
    DocumentRoot ${PANEL_DIR}

    <Directory ${PANEL_DIR}>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    ErrorLog \${APACHE_LOG_DIR}/reycodessh_error.log
    CustomLog \${APACHE_LOG_DIR}/reycodessh_access.log combined
</VirtualHost>
EOF

# Asegurar que Apache escuche el puerto
if ! grep -q "Listen ${PANEL_PORT}" "$PORT_FILE" 2>/dev/null; then
    echo "Listen ${PANEL_PORT}" >> "$PORT_FILE"
fi

# Deshabilitar sitio por defecto si se usa puerto 80
if [ "$PANEL_PORT" = "80" ]; then
    a2dissite 000-default.conf >/dev/null 2>&1
fi

# Habilitar sitio y módulos
a2ensite reycodessh.conf >/dev/null 2>&1
a2enmod rewrite >/dev/null 2>&1
systemctl reload apache2 >/dev/null 2>&1 || systemctl restart apache2 >/dev/null 2>&1

# ─────────────────────────────────────────────
# Resultado final
# ─────────────────────────────────────────────
echo ""
echo -e "${GREEN}✔ Instalación completada correctamente.${NC}"
echo ""
echo -e "🌐 Panel disponible en: ${CYAN}http://${IP_SERVER}:${PANEL_PORT}${NC}"
echo -e "👤 Usuario: ${YELLOW}${PANEL_USER}${NC}"
echo -e "🔑 Contraseña: ${YELLOW}${PANEL_PASS}${NC}"
echo ""
echo -e "Si ves la página por defecto de Apache, ejecuta:"
echo -e "${CYAN}sudo a2dissite 000-default.conf && sudo systemctl reload apache2${NC}"
echo ""
echo -e "${GREEN}Disfruta de tu nuevo Panel Web 🚀${NC}"
