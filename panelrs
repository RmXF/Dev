#!/bin/bash
# instalar_panel_v2.sh
# Instalador/Actualizador Panel ReyCodeSSH v2 (menu lateral)
# Compatible Debian/Ubuntu

set -e

PANEL_DIR="/var/www/reycodessh"
CONF_FILE="/etc/apache2/sites-available/reycodessh.conf"
PORT=80
USER="admin"
PASS="admin123"

# Si quieres que el script descargue un ZIP con el parche/panel desde tu hosting,
# coloca tu link directo aqu√≠ (ej: https://.../panel_reycodessh.zip?dl=1)
# O exporta ZIP_URL antes de ejecutar: export ZIP_URL="https://..."; ./instalar_panel_v2.sh
ZIP_URL="${ZIP_URL:-}"

log() { echo -e "\e[1;36m[INFO]\e[0m $*"; }
err() { echo -e "\e[1;31m[ERROR]\e[0m $*" >&2; }

# 1) Instalar dependencias
log "Actualizando repos e instalando Apache/PHP..."
apt update -y >/dev/null 2>&1
apt install -y apache2 php libapache2-mod-php unzip wget >/dev/null 2>&1

# 2) Si ZIP_URL est√° definido -> descargar y aplicar parche (con backup)
if [ -n "$ZIP_URL" ]; then
  TMPDIR=$(mktemp -d)
  log "Descargando ZIP desde: $ZIP_URL"
  if ! wget -q -O "$TMPDIR/panel.zip" "$ZIP_URL"; then
    err "No se pudo descargar el ZIP desde la URL provista."
    rm -rf "$TMPDIR"
    exit 1
  fi
  log "ZIP descargado. Extraer√© a $TMPDIR/panel_files"
  mkdir -p "$TMPDIR/panel_files"
  unzip -oq "$TMPDIR/panel.zip" -d "$TMPDIR/panel_files" || true
  # Determinar si el ZIP contiene la carpeta ra√≠z o los archivos directamente
  # Buscamos index.php en la carpeta extra√≠da
  if [ -f "$TMPDIR/panel_files/index.php" ]; then
    SRC="$TMPDIR/panel_files"
  else
    # si est√° dentro de una subcarpeta, usar la primera carpeta
    FIRST_DIR=$(find "$TMPDIR/panel_files" -maxdepth 1 -mindepth 1 -type d | head -n1)
    if [ -n "$FIRST_DIR" ]; then
      SRC="$FIRST_DIR"
    else
      SRC="$TMPDIR/panel_files"
    fi
  fi

  # Backup si existe instalaci√≥n previa
  if [ -d "$PANEL_DIR" ]; then
    BACKUP="/root/reycodessh_backup_$(date +%Y%m%d_%H%M%S).tar.gz"
    log "Backup de la instalaci√≥n existente en: $BACKUP"
    tar -czf "$BACKUP" -C "$(dirname "$PANEL_DIR")" "$(basename "$PANEL_DIR")"
    rm -rf "$PANEL_DIR"
  fi

  log "Copiando archivos del ZIP a $PANEL_DIR"
  mkdir -p "$PANEL_DIR"
  cp -a "$SRC/." "$PANEL_DIR/"
  rm -rf "$TMPDIR"
  log "Parche aplicado desde ZIP."
else
  # 3) Si no hay ZIP, instalamos el panel interno (v2) directamente
  log "Instalando panel v2 integrado (sin descargar ZIP)."
  rm -rf "$PANEL_DIR"
  mkdir -p "$PANEL_DIR/assets"
  cat > "$PANEL_DIR/config.php" <<EOF
<?php
\$usuario_panel = "$USER";
\$contrasena_panel = "$PASS";
?>
EOF

  cat > "$PANEL_DIR/index.php" <<'EOF'
<?php
session_start();
include("config.php");
if (isset($_SESSION['usuario'])) {
    header("Location: dashboard.php");
    exit();
}
$error = "";
if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $user = $_POST["usuario"] ?? "";
    $pass = $_POST["contrasena"] ?? "";
    if ($user === $usuario_panel && $pass === $contrasena_panel) {
        $_SESSION['usuario'] = $user;
        header("Location: dashboard.php");
        exit();
    } else {
        $error = "Usuario o contrase√±a incorrectos";
    }
}
?>
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Login - ReyCodeSSH</title>
<link rel="stylesheet" href="assets/style.css">
</head>
<body class="login-body">
  <div class="login-box">
    <h2>Panel Web ReyCodeSSH</h2>
    <form method="POST">
      <input type="text" name="usuario" placeholder="Usuario" required>
      <input type="password" name="contrasena" placeholder="Contrase√±a" required>
      <button type="submit">Ingresar</button>
      <?php if ($error): ?>
        <p class="error"><?= $error ?></p>
      <?php endif; ?>
    </form>
  </div>
  <script src="assets/script.js"></script>
</body>
</html>
EOF

  cat > "$PANEL_DIR/logout.php" <<'EOF'
<?php
session_start();
session_destroy();
header("Location: index.php");
exit();
?>
EOF

  cat > "$PANEL_DIR/dashboard.php" <<'EOF'
<?php
session_start();
if (!isset($_SESSION['usuario'])) {
    header("Location: index.php");
    exit();
}
?>
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dashboard - ReyCodeSSH</title>
<link rel="stylesheet" href="assets/style.css">
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">ReyCodeSSH</div>
    <nav>
      <ul>
        <li class="active"><a href="dashboard.php">üè† Inicio</a></li>
        <li><a href="dashboard.php?page=config">‚öôÔ∏è Configuraci√≥n</a></li>
        <li><a href="logout.php">üîí Cerrar sesi√≥n</a></li>
      </ul>
    </nav>
  </aside>
  <main class="main">
    <header class="main-header">
      <h1>Inicio</h1>
    </header>
    <section class="main-content">
      <?php
      \$page = \$_GET['page'] ?? 'home';
      if (\$page === 'config') {
        echo '<h2>Configuraci√≥n</h2><p>Aqu√≠ ir√° la configuraci√≥n (a√∫n sin opciones).</p>';
      } else {
        echo '<div class="card"><h2>Bienvenido üëã</h2><p>Has iniciado sesi√≥n correctamente en ReyCodeSSH.</p></div>';
        echo '<div class="card"><h3>Informaci√≥n del servidor</h3><ul>';
        echo '<li>PHP: '.phpversion().'</li>';
        echo '<li>Servidor: '.$_SERVER['SERVER_SOFTWARE'].'</li>';
        echo '<li>IP: '.$_SERVER['SERVER_ADDR'].'</li>';
        echo '</ul></div>';
      }
      ?>
    </section>
  </main>
</div>
<script src="assets/script.js"></script>
</body>
</html>
EOF

  cat > "$PANEL_DIR/assets/style.css" <<'EOF'
/* ReyCodeSSH v2 - estilo con sidebar */
:root{
  --bg:#0f172a;
  --panel:#0b1220;
  --card:#111827;
  --muted:#9aa6b2;
  --accent:#2563eb;
  --text:#f8fafc;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Segoe UI,system-ui,Arial;background:var(--bg);color:var(--text)}
.app{display:flex;min-height:100vh}
.sidebar{width:220px;background:var(--panel);padding:20px;display:flex;flex-direction:column}
.brand{font-weight:700;color:var(--accent);font-size:18px;margin-bottom:20px}
.sidebar nav ul{list-style:none;padding:0;margin:0}
.sidebar nav ul li{margin:8px 0}
.sidebar nav ul li a{display:block;color:var(--text);text-decoration:none;padding:10px;border-radius:8px}
.sidebar nav ul li.active a, .sidebar nav ul li a:hover{background:rgba(37,99,235,0.12);color:var(--accent)}
.main{flex:1;display:flex;flex-direction:column}
.main-header{padding:20px;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:space-between}
.main-content{padding:20px;display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px}
.card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
/* Login */
.login-body{display:flex;align-items:center;justify-content:center;height:100vh}
.login-box{background:var(--card);padding:28px;border-radius:12px;width:320px;box-shadow:0 8px 30px rgba(2,6,23,0.6);text-align:center}
.login-box input{width:100%;padding:10px;margin-top:10px;border-radius:8px;border:none;background:#0b1626;color:var(--text)}
.login-box button{width:100%;padding:10px;margin-top:14px;border-radius:8px;border:none;background:var(--accent);color:#fff;font-weight:600;cursor:pointer}
.error{color:#f87171;margin-top:10px}
@media(max-width:800px){
  .sidebar{display:none}
  .main{padding:0}
}
EOF

  echo 'console.log("ReyCodeSSH v2 cargado.");' > "$PANEL_DIR/assets/script.js"
fi

# 4) Permisos
log "Ajustando permisos..."
chown -R www-data:www-data "$PANEL_DIR"
chmod -R 755 "$PANEL_DIR"

# 5) Configurar Apache VirtualHost
log "Configurando Apache VirtualHost..."
IP_SERVER=$(hostname -I | awk '{print $1}' | awk '{print $1}')
cat > "$CONF_FILE" <<EOF
<VirtualHost *:${PORT}>
    ServerAdmin admin@localhost
    ServerName ${IP_SERVER}
    DocumentRoot ${PANEL_DIR}
    <Directory ${PANEL_DIR}>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>
    ErrorLog \${APACHE_LOG_DIR}/reycodessh_error.log
    CustomLog \${APACHE_LOG_DIR}/reycodessh_access.log combined
</VirtualHost>
EOF

# Asegurar puerto en ports.conf
if ! grep -q "Listen ${PORT}" /etc/apache2/ports.conf 2>/dev/null; then
  echo "Listen ${PORT}" >> /etc/apache2/ports.conf
fi

a2dissite 000-default.conf >/dev/null 2>&1 || true
a2ensite reycodessh.conf >/dev/null 2>&1
a2enmod rewrite >/dev/null 2>&1

log "Recargando Apache..."
systemctl reload apache2 >/dev/null 2>&1 || systemctl restart apache2 >/dev/null 2>&1

IP=$(hostname -I | awk '{print $1}' | awk '{print $1}')
log "Instalaci√≥n/actualizaci√≥n completada."
echo ""
echo -e "\e[1;32m‚úî Panel disponible en:\e[0m http://$IP:$PORT"
echo -e "\e[1;33mUsuario:\e[0m $USER"
echo -e "\e[1;33mContrase√±a:\e[0m $PASS"
echo ""
if [ -n "$ZIP_URL" ]; then
  echo "Se aplic√≥ el ZIP desde: $ZIP_URL"
else
  echo "Se instal√≥ la versi√≥n integrada ReyCodeSSH v2."
fi
echo ""
