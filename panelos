#!/bin/bash

# Panel Web con Dashboard - Script de Instalación
# Para VPS Ubuntu/Debian
# Ejecutar como root: sudo bash install_panel.sh

set -e

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Función para imprimir mensajes
print_message() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

# Verificar si se ejecuta como root
if [[ $EUID -ne 0 ]]; then
   print_error "Este script debe ejecutarse como root"
   exit 1
fi

print_message "=== INICIANDO INSTALACIÓN DEL PANEL WEB ==="

# Actualizar sistema
print_message "Actualizando sistema..."
apt-get update && apt-get upgrade -y

# Instalar dependencias necesarias
print_message "Instalando dependencias..."
apt-get install -y apache2 php php-mysql php-curl php-gd php-mbstring \
php-xml php-xmlrpc php-soap php-intl php-zip mysql-server wget curl \
unzip git openssh-server vsftpd ufw fail2ban

# Configurar Apache
print_message "Configurando Apache..."
systemctl enable apache2
systemctl start apache2
a2enmod rewrite
systemctl restart apache2

# Configurar MySQL
print_message "Configurando MySQL..."
mysql <<EOF
CREATE DATABASE IF NOT EXISTS panel_db;
CREATE USER IF NOT EXISTS 'panel_user'@'localhost' IDENTIFIED BY 'PanelPass123!';
GRANT ALL PRIVILEGES ON panel_db.* TO 'panel_user'@'localhost';
FLUSH PRIVILEGES;
EOF

# Crear estructura del panel
print_message "Creando estructura del panel web..."
mkdir -p /var/www/html/panel/{includes,assets/css,assets/js,assets/img,logs}
mkdir -p /var/www/html/panel/{config,api,pages,uploads}

# Configurar permisos
chown -R www-data:www-data /var/www/html/panel
chmod -R 755 /var/www/html/panel

# Crear archivo de configuración
cat > /var/www/html/panel/config/database.php <<'EOF'
<?php
define('DB_HOST', 'localhost');
define('DB_USER', 'panel_user');
define('DB_PASS', 'PanelPass123!');
define('DB_NAME', 'panel_db');

function getConnection() {
    try {
        $conn = new mysqli(DB_HOST, DB_USER, DB_PASS, DB_NAME);
        if ($conn->connect_error) {
            throw new Exception("Connection failed: " . $conn->connect_error);
        }
        return $conn;
    } catch (Exception $e) {
        error_log("Database connection error: " . $e->getMessage());
        return null;
    }
}
?>
EOF

# Crear Dashboard (index.php)
cat > /var/www/html/panel/index.php <<'EOF'
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .sidebar {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            color: white;
            min-height: 100vh;
        }
        .sidebar a {
            color: white;
            text-decoration: none;
            padding: 15px;
            display: block;
            transition: all 0.3s;
        }
        .sidebar a:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(5px);
        }
        .sidebar a i {
            margin-right: 10px;
        }
        .main-content {
            padding: 20px;
        }
        .dashboard-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        .stat-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .stat-icon {
            font-size: 3rem;
            opacity: 0.5;
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 px-0 sidebar">
                <div class="p-4">
                    <h4 class="text-center mb-4"><i class="bi bi-grid"></i> Panel Admin</h4>
                    <hr>
                    <a href="index.php"><i class="bi bi-house-door"></i> Dashboard</a>
                    <a href="?page=users"><i class="bi bi-people"></i> Mostrar Usuarios</a>
                    <a href="?page=add_user"><i class="bi bi-person-plus"></i> Agregar Usuario</a>
                    <a href="?page=logs"><i class="bi bi-journal-text"></i> Logs</a>
                    <a href="?page=settings"><i class="bi bi-gear"></i> Configuración</a>
                    <hr>
                    <a href="?page=logout"><i class="bi bi-box-arrow-right"></i> Salir</a>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content">
                <div class="row">
                    <div class="col-md-3">
                        <div class="stat-card position-relative">
                            <h5>Usuarios SSH</h5>
                            <h2><?php echo exec('cat /etc/passwd | grep /home | wc -l'); ?></h2>
                            <i class="bi bi-people stat-icon"></i>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card position-relative" style="background: linear-gradient(45deg, #f093fb, #f5576c);">
                            <h5>Servicios Activos</h5>
                            <h2><?php echo exec('systemctl list-units --type=service --state=running | wc -l'); ?></h2>
                            <i class="bi bi-gear stat-icon"></i>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card position-relative" style="background: linear-gradient(45deg, #4facfe, #00f2fe);">
                            <h5>Uso de RAM</h5>
                            <h2><?php echo round(exec('free -m | grep Mem | awk \'{print $3/$2 * 100.0}\''), 2); ?>%</h2>
                            <i class="bi bi-memory stat-icon"></i>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card position-relative" style="background: linear-gradient(45deg, #43e97b, #38f9d7);">
                            <h5>Uso de Disco</h5>
                            <h2><?php echo round(exec('df -h / | awk \'NR==2 {print $5}\' | sed \'s/%//\''), 2); ?>%</h2>
                            <i class="bi bi-hdd stat-icon"></i>
                        </div>
                    </div>
                </div>

                <?php
                // Manejo de páginas
                $page = isset($_GET['page']) ? $_GET['page'] : 'dashboard';
                
                if($page == 'users') {
                    include('pages/users.php');
                } elseif($page == 'add_user') {
                    include('pages/add_user.php');
                } elseif($page == 'logs') {
                    include('pages/logs.php');
                } elseif($page == 'settings') {
                    include('pages/settings.php');
                } else {
                    // Dashboard principal
                    ?>
                    <div class="row mt-4">
                        <div class="col-md-12">
                            <div class="dashboard-card">
                                <h4><i class="bi bi-speedometer2"></i> Información del Sistema</h4>
                                <hr>
                                <div class="row">
                                    <div class="col-md-6">
                                        <table class="table">
                                            <tr>
                                                <th>Hostname:</th>
                                                <td><?php echo gethostname(); ?></td>
                                            </tr>
                                            <tr>
                                                <th>IP Local:</th>
                                                <td><?php echo $_SERVER['SERVER_ADDR']; ?></td>
                                            </tr>
                                            <tr>
                                                <th>Sistema Operativo:</th>
                                                <td><?php echo php_uname(); ?></td>
                                            </tr>
                                            <tr>
                                                <th>Uptime:</th>
                                                <td><?php echo exec('uptime -p'); ?></td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <canvas id="usageChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <?php
                }
                ?>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        var ctx = document.getElementById('usageChart').getContext('2d');
        var chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['CPU', 'RAM', 'DISCO'],
                datasets: [{
                    data: [45, 30, 25],
                    backgroundColor: ['#667eea', '#764ba2', '#f093fb']
                }]
            }
        });
    </script>
</body>
</html>
EOF

# Crear página de usuarios (la opción "Mostrar Usuarios")
cat > /var/www/html/panel/pages/users.php <<'EOF'
<div class="dashboard-card">
    <h4><i class="bi bi-people"></i> Mostrar Usuarios del Sistema</h4>
    <hr>
    
    <?php
    if(isset($_GET['delete_user'])) {
        $user_to_delete = $_GET['delete_user'];
        if($user_to_delete != 'root') {
            exec("userdel -r $user_to_delete 2>&1", $output, $return);
            if($return === 0) {
                echo '<div class="alert alert-success">Usuario eliminado exitosamente</div>';
            } else {
                echo '<div class="alert alert-danger">Error al eliminar usuario</div>';
            }
        }
    }
    ?>
    
    <ul class="nav nav-tabs" id="userTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="ssh-tab" data-bs-toggle="tab" data-bs-target="#ssh" type="button">Usuarios SSH</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="system-tab" data-bs-toggle="tab" data-bs-target="#system" type="button">Usuarios Sistema</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="ftp-tab" data-bs-toggle="tab" data-bs-target="#ftp" type="button">Usuarios FTP</button>
        </li>
    </ul>
    
    <div class="tab-content mt-3" id="userTabsContent">
        <!-- Usuarios SSH -->
        <div class="tab-pane fade show active" id="ssh" role="tabpanel">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>UID</th>
                            <th>GID</th>
                            <th>Home</th>
                            <th>Shell</th>
                            <th>Último Login</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php
                        $users = file('/etc/passwd');
                        foreach($users as $user) {
                            $parts = explode(':', $user);
                            if(strpos($parts[6], '/bin/bash') !== false || strpos($parts[6], '/bin/sh') !== false) {
                                echo "<tr>";
                                echo "<td><strong>{$parts[0]}</strong></td>";
                                echo "<td>{$parts[2]}</td>";
                                echo "<td>{$parts[3]}</td>";
                                echo "<td>{$parts[5]}</td>";
                                echo "<td>{$parts[6]}</td>";
                                
                                // Último login
                                $lastlog = exec("lastlog -u {$parts[0]} | tail -n 1 | awk '{print \$4, \$5, \$6, \$7}'");
                                echo "<td>$lastlog</td>";
                                
                                echo "<td>";
                                echo "<a href='?page=users&delete_user={$parts[0]}' class='btn btn-sm btn-danger' onclick='return confirm(\"¿Eliminar usuario?\")'><i class='bi bi-trash'></i></a> ";
                                echo "<a href='#' class='btn btn-sm btn-info'><i class='bi bi-pencil'></i></a>";
                                echo "</td>";
                                echo "</tr>";
                            }
                        }
                        ?>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Usuarios Sistema -->
        <div class="tab-pane fade" id="system" role="tabpanel">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>UID</th>
                            <th>GID</th>
                            <th>Descripción</th>
                            <th>Home</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php
                        foreach($users as $user) {
                            $parts = explode(':', $user);
                            if($parts[2] < 1000 && $parts[2] > 0) {
                                echo "<tr>";
                                echo "<td>{$parts[0]}</td>";
                                echo "<td>{$parts[2]}</td>";
                                echo "<td>{$parts[3]}</td>";
                                echo "<td>{$parts[4]}</td>";
                                echo "<td>{$parts[5]}</td>";
                                echo "</tr>";
                            }
                        }
                        ?>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Usuarios FTP -->
        <div class="tab-pane fade" id="ftp" role="tabpanel">
            <?php
            if(file_exists('/etc/vsftpd/virtual_users')) {
                $ftp_users = file('/etc/vsftpd/virtual_users');
                ?>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Usuario FTP</th>
                                <th>Directorio</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php
                            for($i = 0; $i < count($ftp_users); $i+=2) {
                                echo "<tr>";
                                echo "<td>" . trim($ftp_users[$i]) . "</td>";
                                echo "<td>/home/" . trim($ftp_users[$i]) . "</td>";
                                echo "</tr>";
                            }
                            ?>
                        </tbody>
                    </table>
                </div>
                <?php
            } else {
                echo '<div class="alert alert-info">No hay usuarios FTP configurados</div>';
            }
            ?>
        </div>
    </div>
</div>
EOF

# Crear página para agregar usuarios
cat > /var/www/html/panel/pages/add_user.php <<'EOF'
<div class="dashboard-card">
    <h4><i class="bi bi-person-plus"></i> Agregar Nuevo Usuario</h4>
    <hr>
    
    <?php
    if($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['add_user'])) {
        $username = escapeshellarg($_POST['username']);
        $password = escapeshellarg($_POST['password']);
        $user_type = $_POST['user_type'];
        
        if($user_type == 'ssh') {
            $command = "useradd -m -s /bin/bash " . $username . " && echo " . $username . ":" . $password . " | chpasswd";
        } elseif($user_type == 'ftp') {
            $command = "useradd -m -s /bin/false " . $username . " && echo " . $username . ":" . $password . " | chpasswd";
        }
        
        exec($command . " 2>&1", $output, $return);
        
        if($return === 0) {
            echo '<div class="alert alert-success">Usuario creado exitosamente</div>';
        } else {
            echo '<div class="alert alert-danger">Error al crear usuario: ' . implode("\n", $output) . '</div>';
        }
    }
    ?>
    
    <form method="POST" class="row g-3">
        <div class="col-md-6">
            <label class="form-label">Nombre de Usuario</label>
            <input type="text" name="username" class="form-control" required>
        </div>
        
        <div class="col-md-6">
            <label class="form-label">Contraseña</label>
            <input type="password" name="password" class="form-control" required>
        </div>
        
        <div class="col-md-6">
            <label class="form-label">Tipo de Usuario</label>
            <select name="user_type" class="form-select">
                <option value="ssh">SSH</option>
                <option value="ftp">FTP</option>
                <option value="sftp">SFTP</option>
            </select>
        </div>
        
        <div class="col-md-6">
            <label class="form-label">Cuota de Disco (MB)</label>
            <input type="number" name="quota" class="form-control" value="1024">
        </div>
        
        <div class="col-12">
            <button type="submit" name="add_user" class="btn btn-primary">
                <i class="bi bi-save"></i> Crear Usuario
            </button>
        </div>
    </form>
</div>
EOF

# Configurar firewall
print_message "Configurando firewall..."
ufw allow 22/tcp
ufw allow 80/tcp
ufw allow 443/tcp
ufw allow 21/tcp
ufw --force enable

# Crear archivo de log
touch /var/www/html/panel/logs/access.log
chown www-data:www-data /var/www/html/panel/logs/access.log

# Configurar crontab para monitoreo
(crontab -l 2>/dev/null; echo "*/5 * * * * /usr/bin/php /var/www/html/panel/api/monitor.php >> /var/www/html/panel/logs/monitor.log 2>&1") | crontab -

# Obtener IP
IP_ADDR=$(hostname -I | awk '{print $1}')

print_message "========================================="
print_message "INSTALACIÓN COMPLETADA EXITOSAMENTE!"
print_message "========================================="
print_message "Accede al panel: http://$IP_ADDR/panel/"
print_message ""
print_message "Credenciales MySQL:"
print_message "Base de datos: panel_db"
print_message "Usuario: panel_user"
print_message "Contraseña: PanelPass123!"
print_message ""
print_message "Funcionalidades incluidas:"
print_message "✓ Dashboard con estadísticas del sistema"
print_message "✓ Mostrar Usuarios (opción solicitada)"
print_message "✓ Gestión de usuarios SSH"
print_message "✓ Gestión de usuarios FTP"
print_message "✓ Monitoreo de recursos"
print_message "========================================="

# Guardar información de instalación
cat > /root/panel_info.txt <<EOF
PANEL WEB INSTALADO
Fecha: $(date)
IP: $IP_ADDR
URL: http://$IP_ADDR/panel/
MySQL DB: panel_db
MySQL User: panel_user
MySQL Pass: PanelPass123!
EOF

print_message "Información guardada en: /root/panel_info.txt"
