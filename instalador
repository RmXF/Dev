#!/bin/bash
# =============================================
# ๐ง Instalador Automรกtico - ManagerRS by ReyRS
# =============================================

LOG_FILE="/var/log/managerrs_install.log"
REPO_URL="https://tudominio.com/managerrs.sh"  # <---- ๐ Reemplaza con tu URL real del script
BOT_URL="https://tudominio.com/rsbot.sh"       # <---- ๐ Opcional (si usarรกs el bot)
BIN_PATH="/usr/bin/usercode"
SCRIPT_PATH="/etc/ManagerRS"

# ======== COLORES ========
VERDE="\033[1;32m"
ROJO="\033[1;31m"
AMARILLO="\033[1;33m"
AZUL="\033[1;36m"
RESET="\033[0m"

# ======== FUNCIONES ========

barra_progreso() {
  local mensaje="$1"
  echo -ne "${AMARILLO}${mensaje}${RESET}\r"
  sleep 0.3
  for i in {1..30}; do
    echo -ne "${VERDE}#${RESET}"
    sleep 0.05
  done
  echo -e " ${VERDE}[OK]${RESET}"
}

log() {
  echo "[$(date '+%F %T')] $1" >> "$LOG_FILE"
}

verificar_root() {
  if [[ $EUID -ne 0 ]]; then
    echo -e "${ROJO}โ Debes ejecutar este instalador como root.${RESET}"
    exit 1
  fi
}

verifica_dependencias() {
  echo -e "\n${AZUL}๐ Verificando dependencias necesarias...${RESET}"
  DEPENDENCIAS=(wget curl bc figlet net-tools iptables screen unzip)
  FALTANTES=()

  for pkg in "${DEPENDENCIAS[@]}"; do
    dpkg -s "$pkg" &>/dev/null || FALTANTES+=("$pkg")
  done

  if [ ${#FALTANTES[@]} -eq 0 ]; then
    echo -e "${VERDE}โ Todas las dependencias estรกn instaladas.${RESET}"
  else
    echo -e "${AMARILLO}๐ฆ Instalando dependencias faltantes...${RESET}"
    apt-get update -y &>> "$LOG_FILE"
    apt-get install -y "${FALTANTES[@]}" &>> "$LOG_FILE"
    echo -e "${VERDE}โ Dependencias instaladas correctamente.${RESET}"
  fi
}

descargar_archivos() {
  echo -e "\n${AZUL}โฌ๏ธ Descargando archivos del ManagerRS...${RESET}"
  mkdir -p "$SCRIPT_PATH"

  # Script principal
  barra_progreso "Descargando manager..."
  wget -q -O "$SCRIPT_PATH/managerrs.sh" "$REPO_URL"
  chmod +x "$SCRIPT_PATH/managerrs.sh"

  # Bot (opcional)
  barra_progreso "Descargando bot Telegram..."
  wget -q -O "$SCRIPT_PATH/rsbot.sh" "$BOT_URL"
  chmod +x "$SCRIPT_PATH/rsbot.sh"

  # Acceso rรกpido
  echo "#!/bin/bash" > "$BIN_PATH"
  echo "bash $SCRIPT_PATH/managerrs.sh" >> "$BIN_PATH"
  chmod +x "$BIN_PATH"

  log "Archivos descargados correctamente."
}

finalizar_instalacion() {
  echo -e "\n${AZUL}๐ Finalizando instalaciรณn...${RESET}"
  sleep 1
  echo -e "${VERDE}โ Instalaciรณn completada correctamente.${RESET}"
  echo -e "${AMARILLO}๐ Registro de instalaciรณn:${RESET} $LOG_FILE"
  echo -e "\n${VERDE}Ejecutando el script principal...${RESET}"
  sleep 2
  clear
  bash "$SCRIPT_PATH/managerrs.sh"
}

# ======== EJECUCIรN ========
clear
figlet "ManagerRS" 2>/dev/null || echo -e "${VERDE}ManagerRS - Instalador${RESET}"
echo -e "\033[1;37mโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\033[0m"
echo -e "   ๐ง Instalador automรกtico del panel ManagerRS"
echo -e "   Creado por: ${VERDE}@ReyRS_ViPro${RESET}"
echo -e "\033[1;37mโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\033[0m"

verificar_root
verifica_dependencias
descargar_archivos
finalizar_instalacion
