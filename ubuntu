#!/usr/bin/env bash
set -euo pipefail

PANEL_DIR="/var/www/depaneles/reycodessh"
ZIP_SRC="/mnt/data/reycodessh_v2.zip"

DB_NAME="reycodessh"
DB_USER="reyuser"
DB_PASS="reypasswd"

NGINX_CONF="/etc/nginx/sites-available/reycodessh"

echo "================================================="
echo " ðŸ› ï¸  Instalador AutomÃ¡tico - Reycodessh Panel 2.0"
echo "================================================="

echo "[1/8] Actualizando paquetes..."
apt update -y

echo "[2/8] Instalando dependencias..."
apt install -y nginx php php-fpm php-mysql php-zip php-cli unzip mysql-server

echo "[3/8] Eliminando Apache si existe..."
systemctl stop apache2 2>/dev/null || true
systemctl disable apache2 2>/dev/null || true
apt purge apache2* -y 2>/dev/null || true
apt autoremove -y 2>/dev/null || true

echo "[4/8] Creando carpeta del panel..."
mkdir -p "$PANEL_DIR"

echo "[5/8] Copiando ZIP..."
cp "$ZIP_SRC" "$PANEL_DIR/panel.zip"

echo "[6/8] Descomprimiendo ZIP..."
cd "$PANEL_DIR"
unzip -o panel.zip
rm panel.zip

echo "[7/8] Ajustando permisos..."
chown -R www-data:www-data "$PANEL_DIR"
chmod -R 755 "$PANEL_DIR"

echo "[8/8] Configurando base de datos..."
mysql -e "CREATE DATABASE IF NOT EXISTS $DB_NAME;"
mysql -e "CREATE USER IF NOT EXISTS '$DB_USER'@'localhost' IDENTIFIED BY '$DB_PASS';"
mysql -e "GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'localhost';"
mysql -e "FLUSH PRIVILEGES;"

if [ -f "$PANEL_DIR/database.sql" ]; then
    mysql "$DB_NAME" < "$PANEL_DIR/database.sql"
fi

echo "[9/8] Configurando Nginx..."

cat > "$NGINX_CONF" <<EOF
server {
    listen 80;
    server_name _;

    root $PANEL_DIR;
    index index.php index.html;

    location / {
        try_files \$uri /index.php;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php8.1-fpm.sock;
    }
}
EOF

ln -sf "$NGINX_CONF" /etc/nginx/sites-enabled/reycodessh
nginx -t
systemctl restart nginx

IP=$(hostname -I | awk '{print $1}')

echo "================================================="
echo " ðŸŽ‰ INSTALACIÃ“N COMPLETADA CON Ã‰XITO"
echo "URL: http://$IP/"
echo "Usuario: admin"
echo "ContraseÃ±a: admin"
echo "================================================="
