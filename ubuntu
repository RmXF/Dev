#!/bin/bash
# =============================================
#  ReycodeSSH v4.1 Installer (Apache + HTML)
#  by Venenorks
# =============================================

ZIP_URL="https://github.com/RmXF/Dev/raw/main/ReycodeSSH_v4.zip"
WEB_DIR="/var/www/reycodessh"
CONF_FILE="/etc/apache2/sites-available/reycodessh.conf"

# --- Colors ---
GREEN="\e[32m"
YELLOW="\e[33m"
RED="\e[31m"
RESET="\e[0m"

function progress() {
    local message=$1
    echo -ne "${YELLOW}[‚öôÔ∏è] ${message}...${RESET}"
    sleep 0.5
    echo -e " ${GREEN}OK${RESET}"
}

clear
echo -e "${GREEN}"
echo "==============================================="
echo "   üöÄ Instalador ReycodeSSH v4.1 (Apache)"
echo "==============================================="
echo -e "${RESET}"

# --- Root check ---
if [[ $EUID -ne 0 ]]; then
    echo -e "${RED}‚ùå Este script debe ejecutarse como root${RESET}"
    exit 1
fi

# --- Update system ---
progress "Actualizando paquetes del sistema"
apt update -y &>/dev/null
apt upgrade -y &>/dev/null

# --- Install dependencies ---
progress "Instalando dependencias necesarias"
apt install -y apache2 unzip curl wget ufw &>/dev/null

# --- Download ZIP ---
progress "Descargando sitio web ReycodeSSH v4"
wget -O /tmp/ReycodeSSH_v4.zip "$ZIP_URL" &>/dev/null

# --- Unzip and move site ---
progress "Descomprimiendo sitio"
rm -rf "$WEB_DIR"
mkdir -p "$WEB_DIR"
unzip /tmp/ReycodeSSH_v4.zip -d "$WEB_DIR" &>/dev/null

# --- Set permissions ---
progress "Configurando permisos"
chown -R www-data:www-data "$WEB_DIR"
chmod -R 755 "$WEB_DIR"

# --- Apache configuration ---
progress "Configurando Apache"
cat > "$CONF_FILE" <<EOF
<VirtualHost *:80>
    ServerAdmin admin@localhost
    DocumentRoot $WEB_DIR
    <Directory $WEB_DIR>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>
    ErrorLog \${APACHE_LOG_DIR}/reycodessh_error.log
    CustomLog \${APACHE_LOG_DIR}/reycodessh_access.log combined
</VirtualHost>
EOF

# --- Enable site ---
a2dissite 000-default.conf &>/dev/null
a2ensite reycodessh.conf &>/dev/null
systemctl reload apache2

# --- Firewall rules ---
progress "Configurando firewall (puerto 80)"
ufw allow 80/tcp &>/dev/null
ufw reload &>/dev/null

# --- Cleanup ---
progress "Limpiando archivos temporales"
rm -f /tmp/ReycodeSSH_v4.zip

# --- Detect IP ---
SERVER_IP=$(curl -s ifconfig.me || hostname -I | awk '{print $1}')

# --- Done ---
echo -e "\n${GREEN}‚úÖ Instalaci√≥n completada exitosamente.${RESET}"
echo -e "üåç Tu sitio est√° disponible en: ${YELLOW}http://$SERVER_IP${RESET}\n"
