#!/usr/bin/env bash
# rs-installer.sh - Instalador PRO (Menu rs)
# Versión: 2025-11-15 PRO
# Guarda en /usr/local/bin/rs-installer.sh y chmod +x
set -euo pipefail
IFS=$'\n\t'

########## CONFIG ##########
WWW_BASE="/var/www"
LOG_DIR="/var/log/rs_installer"
BACKUP_DIR="/var/backups/rs"
TIMESTAMP="$(date +'%Y%m%d_%H%M%S')"
LOGFILE="$LOG_DIR/rs_${TIMESTAMP}.log"
NGINX_AVAILABLE="/etc/nginx/sites-available"
NGINX_ENABLED="/etc/nginx/sites-enabled"
CMD_TARGET="/usr/local/bin/rs"
MAX_SIMULATED_TIME=2   # segundos para mostrar pequeñas barras de progreso (solo UX)
########## END CONFIG ##########

mkdir -p "$WWW_BASE" "$LOG_DIR" "$BACKUP_DIR"
touch "$LOGFILE"

# Colors
RED=$'\e[31m'; GREEN=$'\e[32m'; YEL=$'\e[33m'; BLUE=$'\e[34m'; BOLD=$'\e[1m'; RESET=$'\e[0m'

log() { printf "%s %s\n" "[$(date +'%F %T')]" "$*" | tee -a "$LOGFILE"; }
err() { printf "%b\n" "${RED}[ERROR]${RESET} $*" | tee -a "$LOGFILE" >&2; }

### trap to log exits
trap 'rc=$?; if [ $rc -ne 0 ]; then err "Script terminado con codigo $rc. Revisa $LOGFILE"; else log "Script finalizado correctamente."; fi' EXIT

# --------------------------
# Helpers: spinner & progress
# --------------------------
_spinner_pid=""
start_spinner(){
  local msg="${1:-Procesando}"
  printf "%s " "$msg"
  ( while true; do for c in / - \\ \|; do printf "%s\b" "$c"; sleep 0.08; done; done ) &
  _spinner_pid=$!
  disown
}
stop_spinner(){
  if [ -n "$_spinner_pid" ]; then
    kill "$_spinner_pid" >/dev/null 2>&1 || true
    wait "$_spinner_pid" 2>/dev/null || true
    _spinner_pid=""
    printf "\b"
  fi
  echo ""
}

progress_bar_sim(){
  # small simulated progress bar for quick UX
  local duration="${1:-1}"
  local steps=20
  local sleepv
  sleepv=$(awk "BEGIN {print $duration/$steps}")
  printf "["
  for i in $(seq 1 $steps); do
    printf "#"
    sleep "$sleepv"
  done
  printf "]\n"
}

run_and_log(){
  log ">>> Ejecutando: $*"
  "$@" 2>&1 | tee -a "$LOGFILE"
  return ${PIPESTATUS[0]:-0}
}

run_bg_log(){
  log ">>> Ejecutando (bg): $*"
  bash -c "$*" >>"$LOGFILE" 2>&1 &
  local pid=$!
  start_spinner "Ejecutando en background (pid $pid)..."
  wait "$pid"
  stop_spinner
  return $?
}

# --------------------------
# Detect package manager & platform
# --------------------------
detect_platform(){
  local pm="unknown"
  if command -v apt-get >/dev/null 2>&1; then pm="apt"; fi
  if command -v dnf >/dev/null 2>&1; then pm="dnf"; fi
  if command -v yum >/dev/null 2>&1 && [ "$pm" = "unknown" ]; then pm="yum"; fi
  if command -v apk >/dev/null 2>&1; then pm="apk"; fi
  echo "$pm"
}
PKG_MANAGER="$(detect_platform)"
log "Package manager detectado: $PKG_MANAGER"

install_pkgs(){
  local pkgs=("$@")
  case "$PKG_MANAGER" in
    apt)
      run_bg_log "apt-get update -y" sudo apt-get update -y
      run_bg_log "apt-get install -y ${pkgs[*]}" sudo apt-get install -y "${pkgs[@]}"
      ;;
    dnf|yum)
      run_bg_log "$PKG_MANAGER install -y ${pkgs[*]}" sudo "$PKG_MANAGER" install -y "${pkgs[@]}"
      ;;
    apk)
      run_bg_log "apk add ${pkgs[*]}" sudo apk add --no-cache "${pkgs[@]}"
      ;;
    *)
      err "No se detectó un gestor de paquetes soportado. Instala los paquetes manualmente: ${pkgs[*]}"
      return 1
      ;;
  esac
}

# --------------------------
# Ensure required tools exist
# --------------------------
ensure_tools(){
  local wants=(nginx curl wget tar unzip git)
  local miss=()
  for t in "${wants[@]}"; do
    if ! command -v "$t" >/dev/null 2>&1; then miss+=("$t"); fi
  done
  if [ ${#miss[@]} -gt 0 ]; then
    log "Instalando herramientas faltantes: ${miss[*]}"
    install_pkgs "${miss[@]}" || err "Fallo instalando herramientas: ${miss[*]}"
  else
    log "Herramientas básicas presentes."
  fi
}

# --------------------------
# Nginx ensure
# --------------------------
ensure_nginx(){
  if ! command -v nginx >/dev/null 2>&1; then
    log "NGINX no encontrado. Instalando nginx..."
    install_pkgs nginx
  else
    log "NGINX ya instalado."
  fi
  # Enable & start
  if command -v systemctl >/dev/null 2>&1; then
    run_and_log sudo systemctl enable --now nginx || log "Advertencia: no se pudo habilitar systemd para nginx (puede ser que ya esté habilitado)."
  fi
}

# --------------------------
# Site scaffolding
# --------------------------
generate_site_static(){
  local sitename="$1"; local header="$2"; local contact="$3"; local header_text="$4"; local img="$5"
  local site_dir="$WWW_BASE/$sitename"
  mkdir -p "$site_dir"
  cat > "$site_dir/index.html" <<HTML
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>${header} - ${sitename}</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<style>
:root{--bg:#071127;--card:#0c1630;--accent:#00d4ff}
*{box-sizing:border-box}
body{margin:0;min-height:100vh;background:linear-gradient(135deg,var(--bg),#0b1b2b);color:#e6f6ff;font-family:Inter,system-ui,Arial;display:flex;align-items:center;justify-content:center;padding:30px}
.scene{perspective:1400px;width:100%}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04));border-radius:18px;padding:28px;max-width:1100px;margin:0 auto;box-shadow:0 20px 60px rgba(2,6,23,0.75);transform-style:preserve-3d;transition:transform .5s}
.card:hover{transform:rotateX(3deg) rotateY(-6deg)}
.header{display:flex;gap:24px;align-items:center}
.img{flex:0 0 360px;border-radius:12px;overflow:hidden;transform:translateZ(40px)}
.img img{width:100%;height:100%;object-fit:cover}
.meta{flex:1}
h1{margin:0;font-size:clamp(22px,4vw,44px)}
.lead{opacity:.9;margin-top:8px}
.btn{display:inline-block;padding:10px 16px;border-radius:10px;background:linear-gradient(90deg,var(--accent),#6ef);color:#001;font-weight:700;text-decoration:none;margin-top:14px}
.footer{margin-top:14px;opacity:.8;font-size:.9rem}
.glow{position:fixed;inset:0;pointer-events:none;background:
  radial-gradient(600px 200px at 10% 10%, rgba(0,180,255,0.05), transparent 10%),
  radial-gradient(400px 150px at 90% 90%, rgba(0,200,255,0.03), transparent 10%);}
@keyframes floaty{0%{transform:translateY(0)}50%{transform:translateY(-8px)}100%{transform:translateY(0)}}
.floating{animation:floaty 5s ease-in-out infinite}
</style>
</head>
<body>
<div class="scene">
  <div class="card">
    <div class="header">
      <div class="img floating">
        <img src="${img}" alt="imagen" onerror="this.src='https://picsum.photos/640/420?random=1'">
      </div>
      <div class="meta">
        <h1>${header}</h1>
        <p class="lead">${header_text}</p>
        <a class="btn" href="mailto:${contact}">Contactar • ${contact}</a>
        <div class="footer">Sitio: ${sitename} • Generado: $(date +%Y)</div>
      </div>
    </div>
  </div>
</div>
<div class="glow"></div>
</body>
</html>
HTML

  # meta file for patches
  cat > "$site_dir/.rs_meta" <<META
SITE_NAME=${sitename}
HEADER=${header}
CONTACT=${contact}
HEADER_TEXT=${header_text}
IMAGE_URL=${img}
INSTALLED_AT=$(date +'%F %T')
META

  sudo chown -R www-data:www-data "$site_dir" 2>/dev/null || true
  log "Sitio $sitename creado en $site_dir"
}

generate_site_php(){
  local sitename="$1"; local header="$2"; local contact="$3"; local header_text="$4"; local img="$5"
  local site_dir="$WWW_BASE/$sitename"
  mkdir -p "$site_dir"
  cat > "$site_dir/index.php" <<'PHP'
<?php
$header = htmlspecialchars($_ENV['RS_HEADER'] ?? 'Mi sitio PHP');
$header_text = htmlspecialchars($_ENV['RS_HEADER_TEXT'] ?? 'Descripcion breve');
$contact = htmlspecialchars($_ENV['RS_CONTACT'] ?? 'contacto@example.com');
$img = htmlspecialchars($_ENV['RS_IMAGE'] ?? 'https://picsum.photos/640/420?random=1');
?><!doctype html>
<html lang="es"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title><?= $header ?></title></head>
<body style="font-family:Inter,Arial;background:#071127;color:#e6f6ff;padding:30px">
  <h1><?= $header ?></h1>
  <p><?= $header_text ?></p>
  <img src="<?= $img ?>" style="max-width:400px;border-radius:12px">
  <p>Contact: <a href="mailto:<?= $contact ?>"><?= $contact ?></a></p>
</body></html>
PHP

  # .env apache/nginx passthrough via fastcgi_params isn't automatic; we'll write meta to .rs_meta
  cat > "$site_dir/.rs_meta" <<META
SITE_NAME=${sitename}
HEADER=${header}
CONTACT=${contact}
HEADER_TEXT=${header_text}
IMAGE_URL=${img}
INSTALLED_AT=$(date +'%F %T')
META

  sudo chown -R www-data:www-data "$site_dir" 2>/dev/null || true
  log "Sitio PHP $sitename creado."
}

generate_site_node(){
  local sitename="$1"; local header="$2"; local contact="$3"; local header_text="$4"; local img="$5"
  local site_dir="$WWW_BASE/$sitename"
  mkdir -p "$site_dir"
  cat > "$site_dir/package.json" <<JSON
{
  "name": "${sitename//./-}",
  "version": "1.0.0",
  "main": "server.js",
  "scripts": { "start": "node server.js" },
  "dependencies": {}
}
JSON
  cat > "$site_dir/server.js" <<NODE
const http = require('http');
const fs = require('fs');
const path = require('path');
const index = fs.readFileSync(path.join(__dirname,'index.html'),'utf8');
const server = http.createServer((req,res)=>{
  res.writeHead(200,{'Content-Type':'text/html; charset=utf-8'});
  res.end(index);
});
const port = process.env.PORT || 3000;
server.listen(port,()=>console.log('Node site running on',port));
NODE

  # basic index with 3D effect
  cat > "$site_dir/index.html" <<HTML
<!doctype html><html lang="es"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>${header}</title></head>
<body style="background:#071127;color:#e6f6ff;font-family:Inter,Arial;padding:30px">
<h1>${header}</h1>
<p>${header_text}</p>
<img src="${img}" style="max-width:420px;border-radius:12px">
<p>Contact: ${contact}</p>
</body></html>
HTML

  cat > "$site_dir/.rs_meta" <<META
SITE_NAME=${sitename}
HEADER=${header}
CONTACT=${contact}
HEADER_TEXT=${header_text}
IMAGE_URL=${img}
INSTALLED_AT=$(date +'%F %T')
META

  sudo chown -R "$SUDO_USER":"$SUDO_USER" "$site_dir" 2>/dev/null || true
  log "Sitio Node.js creado en $site_dir"
}

# --------------------------
# Nginx Virtual Host config
# --------------------------
configure_nginx_for_site(){
  local sitename="$1"
  local site_dir="$WWW_BASE/$sitename"
  local conf="$NGINX_AVAILABLE/$sitename.conf"
  cat > /tmp/ngx_${sitename}.conf <<NGX
server {
    listen 80;
    server_name ${sitename} _;
    root ${site_dir};
    index index.html index.php;
    location / {
        try_files \$uri \$uri/ =404;
    }
    location ~ \.php\$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php-fpm.sock;
    }
    access_log /var/log/nginx/${sitename}_access.log;
    error_log /var/log/nginx/${sitename}_error.log;
}
NGX
  sudo mkdir -p "$NGINX_AVAILABLE" "$NGINX_ENABLED"
  sudo mv /tmp/ngx_${sitename}.conf "$conf"
  sudo ln -sf "$conf" "$NGINX_ENABLED/$sitename.conf"
  run_and_log sudo nginx -t
  run_and_log sudo systemctl reload nginx || true
  log "NGINX configurado para $sitename"
}

# --------------------------
# Backup site
# --------------------------
backup_site(){
  local sitename="$1"
  local dest="$BACKUP_DIR/${sitename}_backup_$(date +'%Y%m%d_%H%M%S').tar.gz"
  if [ -d "$WWW_BASE/$sitename" ]; then
    tar -C "$WWW_BASE" -czf "$dest" "$sitename"
    log "Backup creado: $dest"
  else
    err "No existe sitio $sitename para backup"
    return 1
  fi
}

# --------------------------
# Patch installer (merge preserving .rs_meta)
# --------------------------
install_patch(){
  local patchpath
  read -rp "Ruta local o URL del parche (.tar.gz) (ENTER para cancelar): " patchpath
  if [ -z "$patchpath" ]; then log "Cancelado."; return 0; fi

  local tmp="/tmp/rs_patch_${TIMESTAMP}_$$"
  mkdir -p "$tmp"
  if [[ "$patchpath" =~ ^https?:// ]]; then
    log "Descargando parche desde $patchpath..."
    if command -v curl >/dev/null 2>&1; then
      run_and_log sudo curl -L -o "$tmp/patch.tar.gz" "$patchpath"
    elif command -v wget >/dev/null 2>&1; then
      run_and_log sudo wget -O "$tmp/patch.tar.gz" "$patchpath"
    else
      err "No hay curl ni wget para descargar."
      return 1
    fi
  else
    if [ ! -f "$patchpath" ]; then err "Archivo no encontrado: $patchpath"; return 1; fi
    cp "$patchpath" "$tmp/patch.tar.gz"
  fi

  tar -xzf "$tmp/patch.tar.gz" -C "$tmp"
  log "Parche extraído en $tmp"

  echo "Sitios detectados:"
  ls -1 "$WWW_BASE" || true
  read -rp "Nombre del sitio a actualizar > " sitename
  if [ -z "$sitename" ] || [ ! -d "$WWW_BASE/$sitename" ]; then err "Sitio inválido"; return 1; fi

  backup_site "$sitename"

  # preserve meta
  if [ -f "$WWW_BASE/$sitename/.rs_meta" ]; then
    cp "$WWW_BASE/$sitename/.rs_meta" "$tmp/.rs_meta.bak" || true
  fi

  log "Aplicando parche (copiando archivos)"
  sudo cp -rT "$tmp" "$WWW_BASE/$sitename" || true

  # restore meta if overwritten
  if [ -f "$tmp/.rs_meta.bak" ] && [ ! -f "$WWW_BASE/$sitename/.rs_meta" ]; then
    sudo mv "$tmp/.rs_meta.bak" "$WWW_BASE/$sitename/.rs_meta" || true
  fi

  sudo chown -R www-data:www-data "$WWW_BASE/$sitename" 2>/dev/null || true
  rm -rf "$tmp"
  log "Parche aplicado con éxito a $sitename"
  run_and_log sudo systemctl reload nginx || true
}

# --------------------------
# Ports & Protocols
# --------------------------
show_protocols(){
  log "Puertos y protocolos activos:"
  if command -v ss >/dev/null 2>&1; then
    run_and_log ss -tuln
  elif command -v netstat >/dev/null 2>&1; then
    run_and_log netstat -tuln
  else
    err "No está instalado ss ni netstat."
  fi
  log "Mapeo rápido (/etc/services si está presente):"
  if [ -f /etc/services ]; then
    awk 'NR<=50{print}' /etc/services | tee -a "$LOGFILE"
  fi
}

# --------------------------
# Uninstall site
# --------------------------
uninstall_site(){
  read -rp "Nombre del sitio a desinstalar > " sitename
  if [ -z "$sitename" ] || [ ! -d "$WWW_BASE/$sitename" ]; then err "Sitio inexistente."; return 1; fi
  read -rp "¿Confirmas eliminar $sitename? escribe 'si' para confirmar: " confirm
  if [ "$confirm" != "si" ]; then log "No confirmado. Abortando."; return 0; fi
  backup_site "$sitename"
  log "Eliminando $WWW_BASE/$sitename ..."
  sudo rm -rf "$WWW_BASE/$sitename"
  sudo rm -f "$NGINX_AVAILABLE/$sitename.conf" || true
  sudo rm -f "$NGINX_ENABLED/$sitename.conf" || true
  run_and_log sudo nginx -t || true
  run_and_log sudo systemctl reload nginx || true
  log "Sitio $sitename eliminado."
}

# --------------------------
# Install flow
# --------------------------
action_install_site(){
  read -rp "Nombre del sitio (ej: ejemplo.com) > " sitename
  if [ -z "$sitename" ]; then err "Nombre inválido."; return 1; fi
  read -rp "Encabezado (texto principal) > " header
  read -rp "Correo de contacto > " contact
  read -rp "Texto secundario/descripcion > " header_text
  read -rp "URL imagen principal (ENTER para placeholder) > " img
  [ -z "$img" ] && img="https://picsum.photos/640/420?random=1"

  log "Preparando instalación para $sitename"
  ensure_tools
  ensure_nginx

  echo "Elige tipo de sitio para instalar:"
  echo "  1) HTML/CSS/JS (estático)"
  echo "  2) PHP + NGINX (sitio con PHP)"
  echo "  3) Node.js (servidor Node simple)"
  echo "  4) Flexible: elegir en tiempo de instalación"
  read -rp "Tipo (1/2/3/4) > " type
  case "$type" in
    1) generate_site_static "$sitename" "$header" "$contact" "$header_text" "$img" ;;
    2)
      log "Instalando PHP-FPM (si es necesario)"
      if [ "$PKG_MANAGER" = "apt" ]; then install_pkgs php-fpm; else install_pkgs php php-fpm; fi
      generate_site_php "$sitename" "$header" "$contact" "$header_text" "$img"
      ;;
    3)
      log "Instalando Node.js runtime (si es necesario)"
      # try minimal install attempt
      if ! command -v node >/dev/null 2>&1; then
        if [ "$PKG_MANAGER" = "apt" ]; then
          install_pkgs nodejs npm || true
        else
          install_pkgs nodejs npm || true
        fi
      fi
      generate_site_node "$sitename" "$header" "$contact" "$header_text" "$img"
      ;;
    4)
      read -rp "Escoge tipo final (1=static,2=php,3=node) > " subtype
      case "$subtype" in
        1) generate_site_static "$sitename" "$header" "$contact" "$header_text" "$img" ;;
        2)
          if [ "$PKG_MANAGER" = "apt" ]; then install_pkgs php-fpm; else install_pkgs php php-fpm; fi
          generate_site_php "$sitename" "$header" "$contact" "$header_text" "$img"
          ;;
        3)
          if ! command -v node >/dev/null 2>&1; then install_pkgs nodejs npm || true; fi
          generate_site_node "$sitename" "$header" "$contact" "$header_text" "$img"
          ;;
        *) err "Tipo inválido. Abortando."; return 1 ;;
      esac
      ;;
    *) err "Opción inválida." ; return 1 ;;
  esac

  configure_nginx_for_site "$sitename"

  # Simulated progress to show status
  log "Finalizando instalación - aplicando permisos y comprobaciones"
  start_spinner "Finalizando..."
  sleep 0.6
  stop_spinner
  log "Instalación completada para $sitename. Revisa $LOGFILE"

  echo ""
  echo "${GREEN}Sitio instalado: http://$sitename${RESET}"
  echo "${YEL}Si usas DNS local sin dominio, prueba con http://localhost o añade entrada en /etc/hosts${RESET}"
  echo ""
  # Offer Let's Encrypt
  read -rp "¿Deseas intentar obtener certificado HTTPS con Let's Encrypt (certbot)? (si/no) > " want_cert
  if [ "$want_cert" = "si" ]; then
    if ! command -v certbot >/dev/null 2>&1; then
      log "Instalando certbot..."
      if [ "$PKG_MANAGER" = "apt" ]; then install_pkgs certbot python3-certbot-nginx; else install_pkgs certbot; fi
    fi
    if command -v certbot >/dev/null 2>&1; then
      log "Intentando certbot --nginx para $sitename (requiere dominio apuntando al servidor)."
      sudo certbot --nginx -d "$sitename" || err "Certbot falló o dominio no apunta correctamente."
    else
      err "Certbot no disponible."
    fi
  fi
}

# --------------------------
# Install command tool (rs)
# --------------------------
install_command_tool(){
  if [ "$(realpath "$0")" != "$CMD_TARGET" ]; then
    log "Instalando comando rs en $CMD_TARGET"
    sudo cp "$0" "$CMD_TARGET"
    sudo chmod +x "$CMD_TARGET"
    log "Comando 'rs' instalado. Ejecuta 'sudo rs' o solo 'rs' si usas root."
  else
    log "El script ya está en $CMD_TARGET"
  fi
}

# --------------------------
# View last log
# --------------------------
view_last_log(){
  less "$LOGFILE"
}

# --------------------------
# MAIN MENU
# --------------------------
main_menu(){
  while true; do
    clear
    cat <<MENU
${BOLD}RS - Instalador PRO (v2025.11.15)${RESET}
Log actual: $LOGFILE

1) Instalar SITIO WEB
2) DESINSTALAR SITIO WEB
3) PROTOCOLOS ACTIVOS
4) INSTALAR PARCHE
5) Ver último log
6) Instalar comando 'rs' (alias)
0) Salir

MENU
    read -rp "> " opt
    case "$opt" in
      1) action_install_site=action_install_site; action_install_site ;;
      2) uninstall_site ;;
      3) show_protocols ;;
      4) install_patch ;;
      5) view_last_log ;;
      6) install_command_tool ;;
      0) log "Saliendo..."; break ;;
      *) echo "Opción inválida"; sleep 1 ;;
    esac
    echo ""
    read -rp "Presiona ENTER para continuar..." _ || true
  done
}

# If invoked with --install-cmd, install and exit
if [ "${1-}" = "--install-cmd" ]; then
  install_command_tool
  exit 0
fi

# If not running as root, warn (some operations require sudo)
if [ "$EUID" -ne 0 ]; then
  echo "${YEL}Nota: algunas operaciones requerirán sudo. Ejecuta 'sudo rs' para que todo funcione sin pedir contraseña constantemente.${RESET}"
fi

# start
main_menu
