#!/usr/bin/env bash
# rs-installer.sh - Instalador PRO actualizado (Entrega IP al finalizar)
# Versión: 2025-11-15 PRO (actualizado)
set -euo pipefail
IFS=$'\n\t'

########## CONFIG ##########
WWW_BASE="/var/www"
LOG_DIR="/var/log/rs_installer"
BACKUP_DIR="/var/backups/rs"
TIMESTAMP="$(date +'%Y%m%d_%H%M%S')"
LOGFILE="$LOG_DIR/rs_${TIMESTAMP}.log"
NGINX_AVAILABLE="/etc/nginx/sites-available"
NGINX_ENABLED="/etc/nginx/sites-enabled"
CMD_TARGET="/usr/local/bin/rs"
########## END CONFIG ##########

mkdir -p "$WWW_BASE" "$LOG_DIR" "$BACKUP_DIR"
touch "$LOGFILE"

# Colors
RED=$'\e[31m'; GREEN=$'\e[32m'; YEL=$'\e[33m'; BLUE=$'\e[34m'; BOLD=$'\e[1m'; RESET=$'\e[0m'

log(){ printf "%s %s\n" "[$(date +'%F %T')]" "$*" | tee -a "$LOGFILE"; }
err(){ printf "%b\n" "${RED}[ERROR]${RESET} $*" | tee -a "$LOGFILE" >&2; }

trap 'rc=$?; if [ $rc -ne 0 ]; then err "Script terminado con codigo $rc. Revisa $LOGFILE"; else log "Script finalizado correctamente."; fi' EXIT

# Helpers
start_spinner(){ local msg="${1:-Procesando}"; printf "%s " "$msg"; ( while true; do for c in / - \\ \|; do printf "%s\b" "$c"; sleep 0.08; done; done ) & _sp=$!; disown; }
stop_spinner(){ if [[ -n "${_sp-}" ]]; then kill "$_sp" >/dev/null 2>&1 || true; wait "$_sp" 2>/dev/null || true; unset _sp; printf "\b"; fi; echo ""; }
run_and_log(){ log ">>> Ejecutando: $*"; "$@" 2>&1 | tee -a "$LOGFILE"; return ${PIPESTATUS[0]:-0}; }
run_bg_log(){ log ">>> Ejecutando (bg): $*"; bash -c "$*" >>"$LOGFILE" 2>&1 & pid=$!; start_spinner "Ejecutando (pid $pid)..."; wait $pid; stop_spinner; return $?; }

# Detect package manager
detect_platform(){
  if command -v apt-get >/dev/null 2>&1; then echo "apt"
  elif command -v dnf >/dev/null 2>&1; then echo "dnf"
  elif command -v yum >/dev/null 2>&1; then echo "yum"
  elif command -v apk >/dev/null 2>&1; then echo "apk"
  else echo "unknown"; fi
}
PKG_MANAGER="$(detect_platform)"; log "Gestor de paquetes detectado: $PKG_MANAGER"

install_pkgs(){
  local pkgs=("$@")
  case "$PKG_MANAGER" in
    apt)
      run_bg_log "apt-get update -y" sudo apt-get update -y
      run_bg_log "apt-get install -y ${pkgs[*]}" sudo apt-get install -y "${pkgs[@]}"
      ;;
    dnf|yum)
      run_bg_log "$PKG_MANAGER install -y ${pkgs[*]}" sudo "$PKG_MANAGER" install -y "${pkgs[@]}"
      ;;
    apk)
      run_bg_log "apk add ${pkgs[*]}" sudo apk add --no-cache "${pkgs[@]}"
      ;;
    *)
      err "Gestor de paquetes no soportado: ${pkgs[*]}"; return 1;;
  esac
}

ensure_tools_and_repos(){
  # On Debian/Ubuntu we might add nodesource if Node needed later - handled in node install
  local need=(nginx curl wget tar unzip git openssl)
  for t in "${need[@]}"; do
    if ! command -v "$t" >/dev/null 2>&1; then missing+=("$t"); fi
  done
  if [ ${#missing[@]:-0} -gt 0 ]; then
    log "Instalando paquetes base: ${missing[*]}"
    install_pkgs "${missing[@]}" || err "No fue posible instalar paquetes base"
  else
    log "Paquetes base ya presentes"
  fi
}

ensure_nginx(){
  if ! command -v nginx >/dev/null 2>&1; then
    log "Instalando nginx..."
    install_pkgs nginx
  else
    log "nginx ya instalado"
  fi
  if command -v systemctl >/dev/null 2>&1; then
    run_and_log sudo systemctl enable --now nginx || log "warning: systemctl enable/reload falló (posible entorno sin systemd)"
  fi
}

# Obtain primary server IP (best-effort)
get_server_ips(){
  # Private/local IP (first non-loopback IPv4)
  local ip_local
  ip_local=$(ip -4 addr show scope global 2>/dev/null | awk '/inet/ {print $2}' | cut -d/ -f1 | head -n1 || true)
  if [ -z "$ip_local" ]; then
    ip_local=$(hostname -I 2>/dev/null | awk '{print $1}' || true)
  fi
  # Public IP (try metadata services, then fallback to external)
  local ip_public=""
  # Try AWS/GCE metadata quickly (non-blocking quick attempts)
  if curl -s --max-time 2 http://169.254.169.254/latest/meta-data/local-ipv4 >/dev/null 2>&1; then
    ip_public=$(curl -s --max-time 2 http://169.254.169.254/latest/meta-data/public-ipv4 || true)
  fi
  if [ -z "$ip_public" ]; then
    ip_public=$(curl -s --max-time 4 https://ifconfig.co || true)
  fi
  echo "${ip_local:-127.0.0.1}|${ip_public:-}"
}

# Site generators
generate_site_static(){
  local s="$1"; local header="$2"; local contact="$3"; local header_text="$4"; local img="$5"
  local d="$WWW_BASE/$s"
  mkdir -p "$d"
  cat > "$d/index.html" <<HTML
<!doctype html><html lang="es"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>${header}</title>
<style>:root{--bg:#071127;--accent:#00d4ff}body{margin:0;background:linear-gradient(135deg,#071127,#0b1b2b);color:#e6f6ff;font-family:Inter,Arial;padding:30px} .card{max-width:1000px;margin:0 auto;background:rgba(255,255,255,0.02);border-radius:16px;padding:28px;box-shadow:0 20px 60px rgba(2,6,23,0.7)} img{border-radius:12px;max-width:100%}</style>
</head><body><div class="card"><h1>${header}</h1><p>${header_text}</p><img src="${img}" alt="imagen" onerror="this.src='https://picsum.photos/640/420?random=1'"><p>Contact: <a href="mailto:${contact}">${contact}</a></p></div></body></html>
HTML
  cat > "$d/.rs_meta" <<META
SITE_NAME=${s}
HEADER=${header}
CONTACT=${contact}
HEADER_TEXT=${header_text}
IMAGE_URL=${img}
INSTALLED_AT=$(date +'%F %T')
META
  sudo chown -R www-data:www-data "$d" 2>/dev/null || true
  log "Site estático creado en $d"
}

generate_site_php(){
  local s="$1"; local header="$2"; local contact="$3"; local header_text="$4"; local img="$5"
  local d="$WWW_BASE/$s"
  mkdir -p "$d"
  cat > "$d/index.php" <<'PHP'
<?php
$header = htmlspecialchars('REPLACE_HEADER');
$header_text = htmlspecialchars('REPLACE_HEADER_TEXT');
$contact = htmlspecialchars('REPLACE_CONTACT');
$img = htmlspecialchars('REPLACE_IMG');
?>
<!doctype html><html lang="es"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title><?= $header ?></title></head><body style="font-family:Inter,Arial;background:#071127;color:#e6f6ff;padding:30px"><h1><?= $header ?></h1><p><?= $header_text ?></p><img src="<?= $img ?>" style="max-width:420px;border-radius:12px"><p>Contact: <a href="mailto:<?= $contact ?>"><?= $contact ?></a></p></body></html>
PHP
  # Replace placeholders
  sed -i "s/REPLACE_HEADER/$(printf '%s' "$header" | sed 's/[\/&]/\\&/g')/" "$d/index.php"
  sed -i "s/REPLACE_HEADER_TEXT/$(printf '%s' "$header_text" | sed 's/[\/&]/\\&/g')/" "$d/index.php"
  sed -i "s/REPLACE_CONTACT/$(printf '%s' "$contact" | sed 's/[\/&]/\\&/g')/" "$d/index.php"
  sed -i "s|REPLACE_IMG|$img|" "$d/index.php"
  cat > "$d/.rs_meta" <<META
SITE_NAME=${s}
HEADER=${header}
CONTACT=${contact}
HEADER_TEXT=${header_text}
IMAGE_URL=${img}
INSTALLED_AT=$(date +'%F %T')
META
  sudo chown -R www-data:www-data "$d" 2>/dev/null || true
  log "Site PHP creado en $d"
}

generate_site_node(){
  local s="$1"; local header="$2"; local contact="$3"; local header_text="$4"; local img="$5"
  local d="$WWW_BASE/$s"
  mkdir -p "$d"
  cat > "$d/package.json" <<JSON
{
  "name": "${s//./-}",
  "version":"1.0.0",
  "main":"server.js",
  "scripts":{"start":"node server.js"}
}
JSON
  cat > "$d/server.js" <<NODE
const http = require('http');
const fs = require('fs');
const path = require('path');
const index = fs.readFileSync(path.join(__dirname,'index.html'),'utf8');
const port = process.env.PORT || 3000;
http.createServer((req,res)=>{ res.writeHead(200,{'Content-Type':'text/html; charset=utf-8'}); res.end(index); }).listen(port,()=>console.log('running',port));
NODE
  cat > "$d/index.html" <<HTML
<!doctype html><html lang="es"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>${header}</title></head><body style="background:#071127;color:#e6f6ff;font-family:Inter,Arial;padding:30px"><h1>${header}</h1><p>${header_text}</p><img src="${img}" style="max-width:420px;border-radius:12px"><p>Contact: ${contact}</p></body></html>
HTML
  cat > "$d/.rs_meta" <<META
SITE_NAME=${s}
HEADER=${header}
CONTACT=${contact}
HEADER_TEXT=${header_text}
IMAGE_URL=${img}
INSTALLED_AT=$(date +'%F %T')
META
  sudo chown -R "$SUDO_USER":"$SUDO_USER" "$d" 2>/dev/null || true
  log "Site Node.js creado en $d"
}

# Configure nginx; for node will reverse proxy to localhost:3000
configure_nginx_for_site(){
  local s="$1"; local type="$2"
  local site_dir="$WWW_BASE/$s"
  local conf="$NGINX_AVAILABLE/$s.conf"
  if [ "$type" = "node" ]; then
    cat > /tmp/ngx_${s}.conf <<NGX
server {
    listen 80;
    server_name ${s} _;
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
    }
    access_log /var/log/nginx/${s}_access.log;
    error_log /var/log/nginx/${s}_error.log;
}
NGX
  else
    cat > /tmp/ngx_${s}.conf <<NGX
server {
    listen 80;
    server_name ${s} _;
    root ${site_dir};
    index index.html index.php;
    location / {
        try_files \$uri \$uri/ =404;
    }
    location ~ \.php\$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php-fpm.sock;
    }
    access_log /var/log/nginx/${s}_access.log;
    error_log /var/log/nginx/${s}_error.log;
}
NGX
  fi
  sudo mkdir -p "$NGINX_AVAILABLE" "$NGINX_ENABLED"
  sudo mv /tmp/ngx_${s}.conf "$conf"
  sudo ln -sf "$conf" "$NGINX_ENABLED/$s.conf"
  run_and_log sudo nginx -t
  run_and_log sudo systemctl reload nginx || true
  log "NGINX configurado para $s (tipo: $type)"
}

# Create systemd service for node site
create_node_service(){
  local s="$1"; local site_dir="$WWW_BASE/$s"; local svc="/etc/systemd/system/rs_node_${s}.service"
  sudo tee "$svc" >/dev/null <<SERVICE
[Unit]
Description=RS Node site ${s}
After=network.target

[Service]
Type=simple
User=${SUDO_USER:-www-data}
WorkingDirectory=${site_dir}
ExecStart=/usr/bin/node server.js
Restart=always
Environment=PORT=3000

[Install]
WantedBy=multi-user.target
SERVICE
  run_and_log sudo systemctl daemon-reload
  run_and_log sudo systemctl enable --now "rs_node_${s}.service"
  log "Servicio systemd creado y arrancado: rs_node_${s}.service"
}

# Backup
backup_site(){ local s="$1"; local dest="$BACKUP_DIR/${s}_backup_$(date +'%Y%m%d_%H%M%S').tar.gz"; if [ -d "$WWW_BASE/$s" ]; then tar -C "$WWW_BASE" -czf "$dest" "$s"; log "Backup: $dest"; else err "No existe $s para backup"; fi }

# Patch installer (preserve .rs_meta)
install_patch(){
  local patchpath; read -rp "Ruta o URL del parche (.tar.gz) (ENTER para cancelar): " patchpath
  if [ -z "$patchpath" ]; then log "Cancelado"; return 0; fi
  local tmp="/tmp/rs_patch_${TIMESTAMP}_$$"; mkdir -p "$tmp"
  if [[ "$patchpath" =~ ^https?:// ]]; then
    if command -v curl >/dev/null 2>&1; then run_and_log sudo curl -L -o "$tmp/patch.tar.gz" "$patchpath"; elif command -v wget >/dev/null 2>&1; then run_and_log sudo wget -O "$tmp/patch.tar.gz" "$patchpath"; else err "No curl/wget"; return 1; fi
  else
    if [ ! -f "$patchpath" ]; then err "No encontrado: $patchpath"; return 1; fi
    cp "$patchpath" "$tmp/patch.tar.gz"
  fi
  tar -xzf "$tmp/patch.tar.gz" -C "$tmp"
  echo "Sitios detectados:"; ls -1 "$WWW_BASE" || true
  read -rp "Nombre del sitio a actualizar > " s
  if [ -z "$s" ] || [ ! -d "$WWW_BASE/$s" ]; then err "Sitio inválido"; return 1; fi
  backup_site "$s"
  if [ -f "$WWW_BASE/$s/.rs_meta" ]; then cp "$WWW_BASE/$s/.rs_meta" "$tmp/.rs_meta.bak" || true; fi
  log "Aplicando parche..."
  sudo cp -rT "$tmp" "$WWW_BASE/$s" || true
  if [ -f "$tmp/.rs_meta.bak" ] && [ ! -f "$WWW_BASE/$s/.rs_meta" ]; then sudo mv "$tmp/.rs_meta.bak" "$WWW_BASE/$s/.rs_meta" || true; fi
  sudo chown -R www-data:www-data "$WWW_BASE/$s" 2>/dev/null || true
  rm -rf "$tmp"; log "Parche aplicado a $s"; run_and_log sudo systemctl reload nginx || true
}

show_protocols(){
  log "Puertos/protocolos activos:"
  if command -v ss >/dev/null 2>&1; then run_and_log ss -tuln; elif command -v netstat >/dev/null 2>&1; then run_and_log netstat -tuln; else err "ss/netstat no disponibles"; fi
}

uninstall_site(){
  read -rp "Nombre del sitio a desinstalar > " s
  if [ -z "$s" ] || [ ! -d "$WWW_BASE/$s" ]; then err "No existe $s"; return 1; fi
  read -rp "Escribe 'si' para confirmar eliminación de $s: " ok
  if [ "$ok" != "si" ]; then log "No confirmado"; return 0; fi
  backup_site "$s"
  sudo rm -rf "$WWW_BASE/$s"
  sudo rm -f "$NGINX_AVAILABLE/$s.conf" || true
  sudo rm -f "$NGINX_ENABLED/$s.conf" || true
  sudo rm -f "/etc/systemd/system/rs_node_${s}.service" || true
  run_and_log sudo nginx -t || true
  run_and_log sudo systemctl reload nginx || true
  run_and_log sudo systemctl daemon-reload || true
  log "Sitio $s eliminado."
}

# Install flow (main)
install_flow(){
  read -rp "Nombre del sitio (ej: ejemplo.com o nombre-local) > " s
  if [ -z "$s" ]; then err "Nombre inválido"; return 1; fi
  read -rp "Encabezado (texto principal) > " header
  read -rp "Correo de contacto > " contact
  read -rp "Texto secundario/descripcion > " header_text
  read -rp "URL imagen principal (ENTER para placeholder) > " img
  [ -z "$img" ] && img="https://picsum.photos/640/420?random=1"

  log "Iniciando instalación para $s"
  ensure_tools_and_repos
  ensure_nginx

  echo "Tipo de sitio:"
  echo " 1) HTML/CSS/JS (estático)"
  echo " 2) PHP + NGINX"
  echo " 3) Node.js (con systemd + reverse-proxy NGINX)"
  read -rp "Elige (1/2/3) > " typ
  case "$typ" in
    1) generate_site_static "$s" "$header" "$contact" "$header_text" "$img"; site_type="static" ;;
    2) 
       log "Instalando PHP-FPM"
       if [ "$PKG_MANAGER" = "apt" ]; then install_pkgs php-fpm; else install_pkgs php php-fpm; fi
       generate_site_php "$s" "$header" "$contact" "$header_text" "$img"; site_type="php" ;;
    3)
       log "Instalando Node.js (si falta) y creando servicio"
       # Try to install Node (simple attempt). For Debian, install nodejs & npm from repo (may be old)
       if ! command -v node >/dev/null 2>&1; then
         if [ "$PKG_MANAGER" = "apt" ]; then
           # install Node from distro or nodesource if necessary
           install_pkgs nodejs npm || true
         else
           install_pkgs nodejs npm || true
         fi
       fi
       generate_site_node "$s" "$header" "$contact" "$header_text" "$img"
       create_node_service "$s"
       site_type="node" ;;
    *) err "Tipo inválido"; return 1 ;;
  esac

  # Create nginx config for the site
  configure_nginx_for_site "$s" "$site_type"

  # Set permissions and reload
  sudo chown -R www-data:www-data "$WWW_BASE/$s" 2>/dev/null || true
  run_and_log sudo systemctl restart nginx || true

  # Open firewall (ufw) if present
  if command -v ufw >/dev/null 2>&1; then
    log "Abriendo puertos 80/443 en ufw"
    run_and_log sudo ufw allow 80/tcp || true
    run_and_log sudo ufw allow 443/tcp || true
  fi

  # Final checks
  log "Verificando estado de nginx..."
  if command -v systemctl >/dev/null 2>&1; then run_and_log sudo systemctl status nginx --no-pager || true; fi

  # Determine IPs and present access links
  IFS='|' read -r IP_LOCAL IP_PUBLIC <<< "$(get_server_ips)"
  [ -z "$IP_LOCAL" ] && IP_LOCAL="127.0.0.1"
  log "Instalación finalizada para $s"
  echo ""
  echo "${GREEN}Acceso al sitio:${RESET}"
  echo "- Por IP local: http://${IP_LOCAL}/"
  if [ -n "$IP_PUBLIC" ]; then echo "- IP pública: http://${IP_PUBLIC}/"; fi
  echo "- Acceso por nombre: http://${s}/ (si DNS o /etc/hosts apuntan al servidor)"
  echo ""
  log "Links: http://${IP_LOCAL}/  http://${s}/"
}

# Install command helper
install_command_tool(){
  if [ "$(realpath "$0")" != "$CMD_TARGET" ]; then
    log "Instalando comando 'rs' en $CMD_TARGET"
    sudo cp "$0" "$CMD_TARGET"
    sudo chmod +x "$CMD_TARGET"
    log "Comando 'rs' instalado."
  else
    log "Script ya en $CMD_TARGET"
  fi
}

view_last_log(){ less "$LOGFILE"; }

# MENU
main_menu(){
  while true; do
    clear
    cat <<MENU
${BOLD}RS - Instalador PRO (actualizado)${RESET}
Log actual: $LOGFILE

1) Instalar SITIO WEB
2) DESINSTALAR SITIO WEB
3) PROTOCOLOS ACTIVOS
4) INSTALAR PARCHE
5) Ver último log
6) Instalar comando 'rs' (alias)
0) Salir

MENU
    read -rp "> " opt
    case "$opt" in
      1) install_flow ;;
      2) uninstall_site ;;
      3) show_protocols ;;
      4) install_patch ;;
      5) view_last_log ;;
      6) install_command_tool ;;
      0) log "Saliendo..."; break ;;
      *) echo "Opción inválida"; sleep 1 ;;
    esac
    echo ""; read -rp "Presiona ENTER para continuar..." _ || true
  done
}

if [ "${1-}" = "--install-cmd" ]; then install_command_tool; exit 0; fi

if [ "$EUID" -ne 0 ]; then echo "${YEL}Nota: algunas operaciones requieren sudo. Ejecuta 'sudo rs' para evitar prompts adicionales.${RESET}"; fi

main_menu
