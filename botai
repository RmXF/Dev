#!/usr/bin/env bash
set -euo pipefail

# ===============================
# Instalador PRO para Telegram AI Bot
# Descarga desde GitHub y despliega:
# https://github.com/RmXF/Dev/blob/main/telegram_ai_bot.zip
# ===============================

ZIP_URL="https://github.com/RmXF/Dev/raw/main/telegram_ai_bot.zip"
BOT_DIR="/opt/telegram_ai_bot_pro"
SERVICE_NAME="telegram_ai_bot_pro"
VENV_DIR="${BOT_DIR}/venv"
NGINX_SITE="/etc/nginx/sites-available/telegram_ai_bot_pro"
LOG_DIR="/var/log/telegram_ai_bot"
CRON_CMD="${VENV_DIR}/bin/python3 ${BOT_DIR}/trainer.py >> /var/log/ai_trainer.log 2>&1"

# Opciones (edítalas si hace falta)
# DOMAIN vacío -> no configura SSL ni webhook automáticamente
DOMAIN="${1:-}"   # opcional: pasa el dominio como primer argumento
TELEGRAM_ADMIN_IDS="${2:-}" # opcional: coma-separados (ej: 12345,67890)

echo "======================================"
echo " Instalador BOT IA TELEGRAM PRO (GitHub)"
echo " Descargando desde: $ZIP_URL"
echo " Instalando en: $BOT_DIR"
echo " Dominio: ${DOMAIN:-<ninguno>}"
echo "======================================"

# 1) Instalar dependencias del sistema
echo "[1/11] Actualizando e instalando paquetes del sistema..."
apt update -y
apt install -y python3 python3-venv python3-pip unzip curl nginx ufw certbot python3-certbot-nginx git

# 2) Crear directorio destino
echo "[2/11] Preparando directorio destino..."
rm -rf "$BOT_DIR"
mkdir -p "$BOT_DIR"
mkdir -p "$LOG_DIR"

# 3) Descargar y descomprimir ZIP
echo "[3/11] Descargando y descomprimiendo el ZIP desde GitHub..."
cd /tmp
curl -L -o telegram_ai_bot.zip "$ZIP_URL"
unzip -o telegram_ai_bot.zip -d "$BOT_DIR"

# 4) Crear entorno virtual e instalar requirements
echo "[4/11] Creando venv e instalando dependencias Python..."
python3 -m venv "$VENV_DIR"
source "$VENV_DIR/bin/activate"
pip install --upgrade pip
if [ -f "${BOT_DIR}/requirements.txt" ]; then
  pip install -r "${BOT_DIR}/requirements.txt"
else
  echo "⚠️ requirements.txt no encontrado en el ZIP. Asegúrate de tenerlo."
fi

# 5) Copiar config y ajustar ADMIN IDs si vienen por parámetro
echo "[5/11] Configuración inicial..."
cd "$BOT_DIR"
if [ ! -f config.json ]; then
  if [ -f config.example.json ]; then
    cp config.example.json config.json
    echo "Se creó config.json desde config.example.json"
  else
    echo "ERROR: No existe config.example.json. Añádelo antes."
    exit 1
  fi
fi

# Insertar ADMIN_USER_IDS si recibidos
if [ -n "$TELEGRAM_ADMIN_IDS" ]; then
  # Reemplaza el array ADMIN_USER_IDS en config.json (simple reemplazo)
  python3 - <<PY
import json,sys
p="config.json"
cfg=json.load(open(p))
ids=[int(x.strip()) for x in "$TELEGRAM_ADMIN_IDS".split(",") if x.strip()]
cfg["ADMIN_USER_IDS"]=ids
open(p,"w").write(json.dumps(cfg, indent=2))
print("ADMIN_USER_IDS actualizados:", ids)
PY
fi

# 6) Inicializar BD si existe script install.sh
echo "[6/11] Inicializando base de datos (si aplicable)..."
if [ -f install.sh ]; then
  bash install.sh || true
fi

# 7) Crear servicio systemd
echo "[7/11] Creando servicio systemd..."
cat > /etc/systemd/system/${SERVICE_NAME}.service <<EOF
[Unit]
Description=Telegram AI Bot PRO
After=network.target

[Service]
Type=simple
WorkingDirectory=${BOT_DIR}
ExecStart=${VENV_DIR}/bin/python3 ${BOT_DIR}/bot.py
Restart=always
RestartSec=5
User=root
StandardOutput=file:${LOG_DIR}/bot.stdout.log
StandardError=file:${LOG_DIR}/bot.stderr.log

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable ${SERVICE_NAME}

# 8) Configurar Nginx: reverse proxy para API y webhook
echo "[8/11] Configurando Nginx (proxy a puerto 5005 interno)..."
cat > "${NGINX_SITE}" <<NGCONF
server {
    listen 80;
    server_name ${DOMAIN:-_};

    # API HTTP local
    location / {
        proxy_pass http://127.0.0.1:5005/;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
    }

    # Optional: healthcheck
    location /health {
        proxy_pass http://127.0.0.1:5005/health;
    }
}
NGCONF

ln -sf "${NGINX_SITE}" /etc/nginx/sites-enabled/telegram_ai_bot_pro
nginx -t && systemctl reload nginx

# 9) Firewall mínimo
echo "[9/11] Configurando UFW (firewall)..."
ufw allow OpenSSH
ufw allow 'Nginx Full'  # 80 and 443
ufw --force enable

# 10) Obtener certificado SSL (si DOMAIN provisto)
if [ -n "$DOMAIN" ]; then
  echo "[10/11] Obteniendo SSL (Let's Encrypt) para ${DOMAIN}..."
  certbot --nginx -d "$DOMAIN" --non-interactive --agree-tos -m "admin@${DOMAIN}" || {
    echo "⚠️ Certbot falló. Revisa logs o asegura que el dominio apunta a este servidor."
  }
fi

# 11) Cron: entrenamiento diario
echo "[11/11] Programando entrenamiento diario a las 03:00am..."
(crontab -l 2>/dev/null | sed '/trainer.py/d'; echo "0 3 * * * ${CRON_CMD}") | crontab -

echo
echo "======================================"
echo " Instalación finalizada."
echo " Inicia el servicio con:"
echo "   systemctl start ${SERVICE_NAME}"
echo " Revisa logs en: ${LOG_DIR}"
if [ -n "$DOMAIN" ]; then
  echo
  echo "Para configurar webhook de Telegram (ejemplo):"
  echo " curl -F 'url=https://${DOMAIN}/webhook' https://api.telegram.org/bot<YOUR_TOKEN>/setWebhook"
fi
echo "======================================"
